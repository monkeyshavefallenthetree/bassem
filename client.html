<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Dashboard - FitCoach</title>
    <style>
        :root {
            --color-primary: #005f6a;
            --color-primary-dark: #004952;
            --color-bg: #f3e7d0;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-bg);
            color: #1f2937;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header */
        .header {
            background: var(--color-bg);
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary);
            text-decoration: none;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-email {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-dark);
        }

        .btn-secondary {
            background: var(--color-primary);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--color-primary-dark);
        }

        .btn-danger {
            background: var(--color-primary);
            color: white;
        }

        .btn-danger:hover {
            background: var(--color-primary-dark);
        }

        /* Main Content */
        .main-content {
            padding: 2rem 0;
        }

        .dashboard-header {
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .dashboard-subtitle {
            color: #6b7280;
            font-size: 1.125rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .stat-title {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
        }

        .stat-change {
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .stat-change.positive {
            color: #16a34a;
        }

        .stat-change.negative {
            color: #dc2626;
        }

        /* Content Sections */
        .content-section {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .section-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }

        .section-content {
            padding: 1.5rem;
        }

        /* Profile Form */
        .profile-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-family: inherit;
            transition: all 0.2s ease;
            background: white;
            color: #1f2937;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 95, 106, 0.1);
        }

        .form-group input[readonly] {
            background: #f9fafb;
            color: #6b7280;
        }

        /* Progress Section */
        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .progress-card {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .progress-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1f2937;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: #2563eb;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.875rem;
            color: #6b7280;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .loading-spinner {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            border: 3px solid #e5e7eb;
            border-radius: 50%;
            border-top-color: #2563eb;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Messages */
        .message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .message.success {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }

        .message.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .message.info {
            background: #eff6ff;
            color: #2563eb;
            border: 1px solid #bfdbfe;
        }

        /* Nutrition Plan Cards */
        .nutrition-plan-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        /* Food replacement button styling */
        .replace-food-btn {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .replace-food-btn:hover {
            background: var(--color-primary-dark);
            transform: translateY(-1px);
        }

        /* Multi-day meal plan styling */
        .day-meal-plan {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .day-header {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            border-radius: 0.5rem 0.5rem 0 0;
        }

        .meal-section {
            margin-bottom: 1rem;
        }

        .meal-header {
            margin: 0 0 0.5rem 0;
            color: #374151;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .food-item-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
            padding: 0.5rem;
            background: #f9fafb;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            align-items: center;
            transition: background-color 0.2s;
        }

        .food-item-grid:hover {
            background: #f3f4f6;
        }

        .empty-meal {
            padding: 0.75rem;
            text-align: center;
            color: #6b7280;
            background: #f9fafb;
            border-radius: 0.375rem;
            border: 1px dashed #d1d5db;
            font-size: 0.875rem;
        }

        /* Responsive adjustments for food replacement */
        @media (max-width: 768px) {
            .replace-food-btn {
                padding: 0.2rem 0.4rem;
                font-size: 0.7rem;
            }
            
            /* Responsive food grid */
            .food-item-grid {
                grid-template-columns: 1fr;
                gap: 0.25rem;
                text-align: center;
            }
            
            .food-item-grid span {
                padding: 0.25rem;
            }
            
            /* Make the food replacement modal responsive */
            .food-replacement-modal {
                margin: 0.5rem !important;
                max-height: 95vh !important;
            }
            
            .food-replacement-content {
                padding: 1rem !important;
            }
            
            .food-replacement-filters {
                grid-template-columns: 1fr !important;
                gap: 0.5rem !important;
            }
            
            .food-replacement-checkboxes {
                grid-template-columns: 1fr !important;
                gap: 0.5rem !important;
            }
        }

        .nutrition-plan-card .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
            background: #d1fae5; /* Default to positive */
            color: #059669; /* Default to positive */
        }

        .nutrition-plan-card .status-badge.active {
            background: #d1fae5;
            color: #059669;
        }

        .nutrition-plan-card .status-badge.inactive {
            background: #fef3c7;
            color: #d97706;
        }

        /* Exercise Section Styles */
        .exercise-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .exercise-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .exercise-title {
            margin: 0 0 0.5rem 0;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .exercise-meta {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .exercise-stats {
            text-align: right;
        }

        .exercise-status {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: inline-block;
        }

        .exercise-status.active {
            background: #d1fae5;
            color: #059669;
        }

        .exercise-status.completed {
            background: #dbeafe;
            color: #2563eb;
        }

        .exercise-status.inactive {
            background: #f3f4f6;
            color: #6b7280;
        }

        .exercise-sets-reps {
            font-size: 1.25rem;
            font-weight: 700;
            color: #2563eb;
        }

        .exercise-sets-reps-label {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .exercise-content {
            margin-bottom: 1rem;
        }

        .exercise-section {
            margin-bottom: 1rem;
        }

        .exercise-section-title {
            margin: 0 0 0.5rem 0;
            color: #374151;
            font-size: 1rem;
            font-weight: 600;
        }

        .exercise-description {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #2563eb;
            margin: 0;
            color: #374151;
            line-height: 1.6;
        }

        .exercise-notes {
            background: #fef3c7;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #f59e0b;
            margin: 0;
            color: #92400e;
            line-height: 1.6;
        }

        .exercise-video {
            background: #f0f9ff;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #0ea5e9;
        }

        .exercise-video-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #0c4a6e;
            margin-bottom: 0.5rem;
        }

        .exercise-video-text {
            margin: 0;
            font-size: 0.875rem;
            color: #0c4a6e;
        }



        .exercise-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .exercise-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .exercise-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .exercise-btn-complete {
            background: #10b981;
            color: white;
        }

        .exercise-btn-complete:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
        }

        .exercise-btn-view {
            background: #2563eb;
            color: white;
        }

        .exercise-btn-view:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .profile-form {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .progress-grid {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .exercise-header {
                flex-direction: column;
                gap: 1rem;
            }

            .exercise-stats {
                text-align: left;
            }

            .exercise-actions {
                flex-direction: column;
            }

            .exercise-btn {
                justify-content: center;
            }
        }

        /* Authentication Screen */
        .auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .auth-card {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        .auth-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #1f2937;
        }

        .auth-form .form-group {
            margin-bottom: 1.5rem;
        }

        .auth-form .btn {
            width: 100%;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-screen" style="display: none;">
        <div class="auth-card">
            <h1 class="auth-title">Welcome to Your Dashboard</h1>
            <p style="text-align: center; color: #6b7280; margin-bottom: 2rem;">
                Please log in to access your client dashboard.
            </p>
            <form id="loginForm" class="auth-form">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    Login to Dashboard
                </button>
            </form>
            <p style="text-align: center; margin-top: 1rem; color: #6b7280;">
                Don't have an account? <a href="index.html" style="color: #2563eb;">Register here</a>
            </p>
        </div>
    </div>

    <!-- Client Dashboard -->
    <div id="dashboard" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <a href="index.html" class="logo">FitCoach</a>
                    <div class="user-menu">
                        <span class="user-email" id="userEmail"></span>
                        <button class="btn btn-secondary" id="logoutBtn">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <!-- Dashboard Header -->
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Welcome back, <span id="userName">Client</span>!</h1>
                    <p class="dashboard-subtitle">Track your progress and manage your fitness journey</p>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-title">Current Weight</div>
                        <div class="stat-value" id="currentWeight">-- kg</div>
                        <div class="stat-change" id="weightChange"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Goal Progress</div>
                        <div class="stat-value" id="goalProgress">--%</div>
                        <div class="stat-change" id="progressChange"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Days Active</div>
                        <div class="stat-value" id="daysActive">0</div>
                        <div class="stat-change">This month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Next Session</div>
                        <div class="stat-value" id="nextSession">--</div>
                        <div class="stat-change">Scheduled</div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">My Profile</h2>
                    </div>
                    <div class="section-content">
                        <form id="profileForm" class="profile-form">
                            <div class="form-group">
                                <label for="profileName">Full Name</label>
                                <input type="text" id="profileName" name="name" readonly>
                            </div>
                            <div class="form-group">
                                <label for="profileEmail">Email Address</label>
                                <input type="email" id="profileEmail" name="email" readonly>
                            </div>
                            <div class="form-group">
                                <label for="profilePhone">Phone Number</label>
                                <input type="tel" id="profilePhone" name="phone" readonly>
                            </div>
                            <div class="form-group">
                                <label for="profileAge">Age</label>
                                <input type="number" id="profileAge" name="age" readonly>
                            </div>
                            <div class="form-group">
                                <label for="profileWeight">Current Weight (kg)</label>
                                <input type="number" id="profileWeight" name="weight" step="0.1">
                            </div>
                            <div class="form-group">
                                <label for="profileHeight">Height (cm)</label>
                                <input type="number" id="profileHeight" name="height" readonly>
                            </div>
                            <div class="form-group">
                                <label for="profileGoals">Fitness Goals</label>
                                <select id="profileGoals" name="goals" readonly>
                                    <option value="weight-loss">Weight Loss</option>
                                    <option value="muscle-gain">Muscle Gain</option>
                                    <option value="strength">Strength Building</option>
                                    <option value="endurance">Endurance</option>
                                    <option value="general">General Fitness</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <button type="submit" class="btn btn-primary">Update Weight</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Progress Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">My Progress</h2>
                    </div>
                    <div class="section-content">
                        <div class="progress-grid">
                            <div class="progress-card">
                                <div class="progress-title">Weight Goal Progress</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="weightProgressBar" style="width: 0%"></div>
                                </div>
                                <div class="progress-text" id="weightProgressText">Set your weight goal to start tracking</div>
                            </div>
                            <div class="progress-card">
                                <div class="progress-title">Workout Consistency</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="workoutProgressBar" style="width: 0%"></div>
                                </div>
                                <div class="progress-text" id="workoutProgressText">Complete workouts to see your progress</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- My Orders Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">My Orders</h2>
                        <button onclick="loadOrders()" class="btn btn-outline" style="margin-left: auto;">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="section-content">
                        <div id="ordersContainer">
                            <div class="loading" id="ordersLoadingMessage">Loading orders...</div>
                        </div>
                    </div>
                </div>

                <!-- Nutrition Plans Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">My Nutrition Plans</h2>
                    </div>
                    <div class="section-content">
                        <div id="nutritionPlansContainer">
                            <div class="loading" id="nutritionLoadingMessage">Loading nutrition plans...</div>
                        </div>
                    </div>
                </div>

                <!-- Exercises Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">My Exercises</h2>
                    </div>
                    <div class="section-content">
                        <div id="exercisesContainer">
                            <div class="loading" id="exercisesLoadingMessage">Loading exercises...</div>
                        </div>
                    </div>
                </div>

                <!-- Messages Container -->
                <div id="messagesContainer"></div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB1dOBoH9GHnxAJhuax2_SLtaY8sfFuncY",
            authDomain: "gyma-249b7.firebaseapp.com",
            projectId: "gyma-249b7",
            storageBucket: "gyma-249b7.firebasestorage.app",
            messagingSenderId: "169812675743",
            appId: "1:169812675743:web:96edecbeb219d06f9da6aa",
            measurementId: "G-RSRZ508FK4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Make Firebase functions available globally
        window.db = db;
        window.auth = auth;
        window.doc = doc;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        
        // Will assign food replacement function after it's defined

        // Global variables
        let currentUser = null;
        let userData = null;

        // DOM elements
        const authScreen = document.getElementById('authScreen');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const profileForm = document.getElementById('profileForm');
        const messagesContainer = document.getElementById('messagesContainer');

        // Check authentication state
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                console.log('User authenticated:', user.uid, user.email);
                // User is signed in
                await loadUserData();
                showDashboard();
                
                // Add a small delay to ensure full authentication before loading data
                setTimeout(() => {
                                    console.log('Loading user data after authentication delay...');
                testFirestoreConnection();
                loadOrders();
                loadNutritionPlans();
                loadExercises();
                }, 1000);
            } else {
                console.log('User not authenticated');
                // User is signed out
                showAuthScreen();
            }
        });

        // Show authentication screen
        function showAuthScreen() {
            if (authScreen) {
            authScreen.style.display = 'flex';
            } else {
                console.error('❌ authScreen element not found');
            }
            
            if (dashboard) {
            dashboard.style.display = 'none';
            } else {
                console.error('❌ dashboard element not found');
            }
        }

        // Show dashboard
        function showDashboard() {
            if (authScreen) {
            authScreen.style.display = 'none';
            } else {
                console.error('❌ authScreen element not found');
            }
            
            if (dashboard) {
            dashboard.style.display = 'block';
            } else {
                console.error('❌ dashboard element not found');
            }
        }

        // Load user data from Firestore
        async function loadUserData() {
            try {
                // Get user data from clients collection
                const clientsQuery = query(collection(db, "clients"), where("uid", "==", currentUser.uid));
                const clientsSnapshot = await getDocs(clientsQuery);
                
                if (!clientsSnapshot.empty) {
                    const clientDoc = clientsSnapshot.docs[0];
                    userData = {
                        id: clientDoc.id,
                        ...clientDoc.data()
                    };
                    updateDashboard();
                } else {
                    showMessage('User data not found. Please contact support.', 'error');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showMessage('Error loading user data. Please try again.', 'error');
            }
        }

        // Update dashboard with user data
        function updateDashboard() {
            if (!userData) return;

            // Update header
            const userNameEl = document.getElementById('userName');
            if (userNameEl) {
                userNameEl.textContent = userData.name || 'Client';
            } else {
                console.error('❌ userName element not found');
            }
            
            const userEmailEl = document.getElementById('userEmail');
            if (userEmailEl) {
                userEmailEl.textContent = currentUser.email;
            } else {
                console.error('❌ userEmail element not found');
            }

            // Update profile form
            const profileElements = {
                'profileName': userData.name || '',
                'profileEmail': userData.email || '',
                'profilePhone': userData.phone || '',
                'profileAge': userData.age || '',
                'profileWeight': userData.weight || '',
                'profileHeight': userData.height || '',
                'profileGoals': userData.goals || ''
            };
            
            Object.entries(profileElements).forEach(([elementId, value]) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.value = value;
                } else {
                    console.error(`❌ ${elementId} element not found`);
                }
            });

            // Update stats
            const currentWeightEl = document.getElementById('currentWeight');
            if (currentWeightEl) {
                currentWeightEl.textContent = userData.weight ? `${userData.weight} kg` : '-- kg';
            } else {
                console.error('❌ currentWeight element not found');
            }
            
            // Calculate BMI if weight and height are available
            if (userData.weight && userData.height) {
                const heightInMeters = userData.height / 100;
                const bmi = (userData.weight / (heightInMeters * heightInMeters)).toFixed(1);
                
                const goalProgressEl = document.getElementById('goalProgress');
                if (goalProgressEl) {
                    goalProgressEl.textContent = `${bmi}`;
                } else {
                    console.error('❌ goalProgress element not found');
                }
                
                const progressChangeEl = document.getElementById('progressChange');
                if (progressChangeEl) {
                    progressChangeEl.textContent = 'BMI';
                } else {
                    console.error('❌ progressChange element not found');
                }
            }

            // Update progress bars (placeholder data)
            updateProgressBars();
            
            // Note: loadNutritionPlans() is now called after authentication delay
        }

        // Update progress bars
        function updateProgressBars() {
            try {
            // Weight progress (placeholder - you can implement actual goal tracking)
            const weightProgress = 65; // Example: 65% progress
                const weightProgressBar = document.getElementById('weightProgressBar');
                const weightProgressText = document.getElementById('weightProgressText');
                
                if (weightProgressBar) {
                    weightProgressBar.style.width = `${weightProgress}%`;
                } else {
                    console.error('❌ weightProgressBar element not found');
                }
                
                if (weightProgressText) {
                    weightProgressText.textContent = `${weightProgress}% of weight goal achieved`;
                } else {
                    console.error('❌ weightProgressText element not found');
                }

            // Workout progress (placeholder)
            const workoutProgress = 40; // Example: 40% progress
                const workoutProgressBar = document.getElementById('workoutProgressBar');
                const workoutProgressText = document.getElementById('workoutProgressText');
                
                if (workoutProgressBar) {
                    workoutProgressBar.style.width = `${workoutProgress}%`;
                } else {
                    console.error('❌ workoutProgressBar element not found');
                }
                
                if (workoutProgressText) {
                    workoutProgressText.textContent = `${workoutProgress}% of monthly workout goal`;
                } else {
                    console.error('❌ workoutProgressText element not found');
                }
            } catch (error) {
                console.error('❌ Error updating progress bars:', error);
            }
        }

        // Test Firestore connection and permissions
        async function testFirestoreConnection() {
            try {
                console.log('=== TESTING FIRESTORE CONNECTION ===');
                console.log('Current user:', currentUser);
                console.log('Auth state:', auth.currentUser);
                console.log('Database object:', db);
                
                // Test basic connection to both collections
                const consultationsQuery = query(collection(db, "consultations"));
                const ordersQuery = query(collection(db, "orders"));
                console.log('Basic queries created successfully for both collections');
                
                // Test with limit to avoid getting too much data
                const consultationsSnapshot = await getDocs(query(collection(db, "consultations"), limit(1)));
                console.log('Consultations query executed successfully, docs found:', consultationsSnapshot.size);
                
                const ordersSnapshot = await getDocs(query(collection(db, "orders"), limit(1)));
                console.log('Orders query executed successfully, docs found:', ordersSnapshot.size);
                
                // Test user-specific query with different field names
                if (currentUser?.email) {
                    console.log('Testing queries for user email:', currentUser.email);
                    
                    // Test userEmail field
                    const userEmailQuery = query(
                        collection(db, "consultations"), 
                        where("userEmail", "==", currentUser.email),
                        limit(10)
                    );
                    const userEmailSnapshot = await getDocs(userEmailQuery);
                    console.log(`Query with 'userEmail' field found:`, userEmailSnapshot.size, 'documents');
                    
                    // Test customerEmail field
                    const customerEmailQuery = query(
                        collection(db, "consultations"), 
                        where("customerEmail", "==", currentUser.email),
                        limit(10)
                    );
                    const customerEmailSnapshot = await getDocs(customerEmailQuery);
                    console.log(`Query with 'customerEmail' field found:`, customerEmailSnapshot.size, 'documents');
                    
                    // Test email field
                    const emailQuery = query(
                        collection(db, "consultations"), 
                        where("email", "==", currentUser.email),
                        limit(10)
                    );
                    const emailSnapshot = await getDocs(emailQuery);
                    console.log(`Query with 'email' field found:`, emailSnapshot.size, 'documents');
                    
                    // Log first few documents to see structure
                    const allDocsQuery = query(collection(db, "consultations"), limit(3));
                    const allDocsSnapshot = await getDocs(allDocsQuery);
                    console.log('Sample documents in consultations collection:');
                    allDocsSnapshot.forEach((doc, index) => {
                        console.log(`Document ${index + 1}:`, doc.data());
                    });
                }
                
                console.log('✅ Firestore connection test passed');
                
            } catch (error) {
                console.error('❌ Firestore connection test failed:');
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Full error:', error);
            }
        }

        // Load orders for the current user
        async function loadOrders() {
            try {
                console.log('=== LOADING ORDERS ===');
                console.log('Current user:', currentUser?.email);
                
                if (!currentUser || !currentUser.email) {
                    console.error('No authenticated user found');
                    return;
                }
                
                const ordersContainer = document.getElementById('ordersContainer');
                const loadingMessage = document.getElementById('ordersLoadingMessage');
                
                // Query both collections for this user's data
                console.log('🔍 Querying orders and consultations for user:', currentUser.email);
                
                let allOrders = [];
                
                // === ORDERS COLLECTION (new coaching program orders) ===
                console.log('📦 Querying ORDERS collection...');
                try {
                    // Try customerEmail field (from cart checkout)
                    const ordersCustomerEmailQuery = query(
                        collection(db, "orders"), 
                        where("customerEmail", "==", currentUser.email)
                    );
                    const ordersCustomerSnapshot = await getDocs(ordersCustomerEmailQuery);
                    console.log('Found coaching orders with customerEmail:', ordersCustomerSnapshot.size);
                    ordersCustomerSnapshot.forEach((doc) => {
                        allOrders.push({ id: doc.id, collection: 'orders', ...doc.data() });
                    });
                } catch (error) {
                    console.log('Orders customerEmail query failed:', error.message);
                }
                
                // === CONSULTATIONS COLLECTION (consultation requests) ===
                console.log('📞 Querying CONSULTATIONS collection...');
                try {
                    // Try userEmail field (from contact form)
                    const consultationsUserEmailQuery = query(
                        collection(db, "consultations"), 
                        where("userEmail", "==", currentUser.email)
                    );
                    const consultationsUserSnapshot = await getDocs(consultationsUserEmailQuery);
                    console.log('Found consultations with userEmail:', consultationsUserSnapshot.size);
                    consultationsUserSnapshot.forEach((doc) => {
                        allOrders.push({ id: doc.id, collection: 'consultations', ...doc.data() });
                    });
                } catch (error) {
                    console.log('Consultations userEmail query failed:', error.message);
                }
                
                try {
                    // Try customerEmail field in consultations (legacy cart orders)
                    const consultationsCustomerEmailQuery = query(
                        collection(db, "consultations"), 
                        where("customerEmail", "==", currentUser.email)
                    );
                    const consultationsCustomerSnapshot = await getDocs(consultationsCustomerEmailQuery);
                    console.log('Found legacy cart orders in consultations with customerEmail:', consultationsCustomerSnapshot.size);
                    consultationsCustomerSnapshot.forEach((doc) => {
                        // Avoid duplicates
                        if (!allOrders.find(order => order.id === doc.id)) {
                            allOrders.push({ id: doc.id, collection: 'consultations', ...doc.data() });
                        }
                    });
                } catch (error) {
                    console.log('Consultations customerEmail query failed:', error.message);
                }
                
                try {
                    // Try email field (legacy)
                    const consultationsEmailQuery = query(
                        collection(db, "consultations"), 
                        where("email", "==", currentUser.email)
                    );
                    const consultationsEmailSnapshot = await getDocs(consultationsEmailQuery);
                    console.log('Found consultations with email field:', consultationsEmailSnapshot.size);
                    consultationsEmailSnapshot.forEach((doc) => {
                        // Avoid duplicates
                        if (!allOrders.find(order => order.id === doc.id)) {
                            allOrders.push({ id: doc.id, collection: 'consultations', ...doc.data() });
                        }
                    });
                } catch (error) {
                    console.log('Consultations email query failed:', error.message);
                }
                
                console.log('Total unique orders found:', allOrders.length);
                console.log('All orders data:', allOrders);
                
                if (loadingMessage) {
                    loadingMessage.style.display = 'none';
                }
                
                // Sort orders by timestamp (newest first)
                allOrders.sort((a, b) => {
                    const timestampA = new Date(a.timestamp || a.createdAt || 0);
                    const timestampB = new Date(b.timestamp || b.createdAt || 0);
                    return timestampB - timestampA;
                });
                
                if (allOrders.length === 0) {
                    // Show debug information to help identify the issue
                    ordersContainer.innerHTML = `
                        <div style="text-align: center; padding: 3rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">📦</div>
                            <h3 style="color: #1f2937; margin-bottom: 1rem;">No Orders Found</h3>
                            <p style="color: #6b7280; margin-bottom: 1rem;">
                                No orders found for your account. This could be because:
                            </p>
                            <div style="text-align: left; max-width: 500px; margin: 0 auto 2rem auto; background: #f9fafb; padding: 1.5rem; border-radius: 0.5rem;">
                                <ul style="margin: 0; padding-left: 1.5rem; color: #6b7280; line-height: 1.6;">
                                    <li>You haven't placed any orders yet</li>
                                    <li>Orders were placed with a different email address</li>
                                    <li>You're logged in with a different account</li>
                                </ul>
                                <div style="margin-top: 1rem; padding: 1rem; background: #f0f9ff; border-radius: 0.25rem;">
                                    <p style="margin: 0; font-size: 0.875rem;"><strong>Your current email:</strong> ${currentUser?.email || 'Not available'}</p>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;"><strong>Debug info:</strong> Check browser console (F12) for detailed query results.</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                <a href="index.html#services" style="background: #2563eb; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
                                    🛒 Browse Services
                                </a>
                                <button onclick="showAllOrdersDebug()" style="background: #059669; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem;">
                                    🔍 Debug Orders
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Render orders
                ordersContainer.innerHTML = allOrders.map(order => {
                    const isCoachingOrder = order.type === 'coaching-program-order';
                    const orderTimestamp = order.timestamp || order.createdAt;
                    const orderDate = orderTimestamp ? new Date(orderTimestamp).toLocaleDateString() : 'Unknown date';
                    const orderTime = orderTimestamp ? new Date(orderTimestamp).toLocaleTimeString() : '';
                    
                    // Determine order type and details
                    let orderTypeIcon = '📞';
                    let orderTypeName = 'Consultation';
                    let orderDetails = '';
                    let totalAmount = 0;
                    let currency = 'EGP';
                    
                    if (isCoachingOrder) {
                        orderTypeIcon = '🏋️‍♂️';
                        orderTypeName = 'Coaching Programs';
                        totalAmount = order.total || 0;
                        currency = '$';
                        
                        if (order.items && order.items.length > 0) {
                            orderDetails = order.items.map(item => 
                                `<div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #f3f4f6;">
                                    <span>${item.serviceName} × ${item.quantity}</span>
                                    <span style="font-weight: 600;">$${item.price * item.quantity}</span>
                                </div>`
                            ).join('');
                        }
                    } else {
                        // Consultation or nutrition plan
                        if (order.serviceType === 'nutrition-plan') {
                            orderTypeIcon = '🥗';
                            orderTypeName = 'Nutrition Plan';
                            totalAmount = order.servicePrice || 500;
                        } else if (order.serviceType === 'full-program') {
                            orderTypeIcon = '💪';
                            orderTypeName = 'Full Program';
                            totalAmount = order.servicePrice || 1200;
                        } else {
                            orderTypeName = 'Free Consultation';
                            totalAmount = 0;
                        }
                        
                        orderDetails = `<div style="padding: 0.5rem 0; color: #6b7280;">
                            ${order.goals ? `<div><strong>Goals:</strong> ${order.goals}</div>` : ''}
                            ${order.message ? `<div style="margin-top: 0.5rem;"><strong>Message:</strong> ${order.message}</div>` : ''}
                        </div>`;
                    }
                    
                    // Payment status styling
                    let statusColor = '#6b7280';
                    let statusText = 'Unknown';
                    let statusIcon = '❓';
                    
                    switch (order.paymentStatus) {
                        case 'pending':
                            statusColor = '#d97706';
                            statusText = 'Payment Pending';
                            statusIcon = '⏳';
                            break;
                        case 'confirmed':
                            statusColor = '#059669';
                            statusText = 'Payment Confirmed';
                            statusIcon = '✅';
                            break;
                        case 'not-required':
                            statusColor = '#6b7280';
                            statusText = 'Free Service';
                            statusIcon = '🆓';
                            break;
                        default:
                            if (totalAmount === 0) {
                                statusColor = '#6b7280';
                                statusText = 'Free Service';
                                statusIcon = '🆓';
                            } else {
                                statusColor = '#dc2626';
                                statusText = 'Payment Required';
                                statusIcon = '💳';
                            }
                    }
                    
                    return `
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <div>
                                    <h3 style="margin: 0 0 0.5rem 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                                        ${orderTypeIcon} ${orderTypeName}
                                    </h3>
                                    <div style="color: #6b7280; font-size: 0.875rem;">
                                        Order ID: ${order.id.substring(0, 8)}...
                                    </div>
                                    <div style="color: #6b7280; font-size: 0.875rem;">
                                        ${orderDate} at ${orderTime}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="background: ${statusColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; margin-bottom: 0.5rem;">
                                        ${statusIcon} ${statusText}
                                    </div>
                                    ${totalAmount > 0 ? `<div style="font-size: 1.25rem; font-weight: 700; color: #2563eb;">${currency}${totalAmount}</div>` : ''}
                                </div>
                            </div>
                            
                            ${orderDetails}
                            
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.875rem;">
                                    <div>
                                        <strong>Contact:</strong><br>
                                        ${order.customerName || order.name || 'N/A'}<br>
                                        ${order.customerEmail || order.email || 'N/A'}<br>
                                        ${order.customerPhone || order.phone || 'N/A'}
                                    </div>
                                    ${order.paymentMethod ? `
                                        <div>
                                            <strong>Payment Method:</strong><br>
                                            ${order.paymentMethod === 'instapay' ? '💳 InstaPay' : 
                                              order.paymentMethod === 'bank-transfer' ? '🏦 Bank Transfer' : 
                                              order.paymentMethod === 'cash' ? '💰 Cash Payment' : order.paymentMethod}
                                            ${order.paymentConfirmedAt ? `<br><span style="color: #059669;">Confirmed: ${new Date(order.paymentConfirmedAt).toLocaleDateString()}</span>` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                                
                                ${order.paymentStatus === 'pending' && order.paymentMethod === 'instapay' ? `
                                    <div style="margin-top: 1rem; padding: 1rem; background: #f0f9ff; border-radius: 0.5rem; border-left: 4px solid #2563eb;">
                                        <h4 style="margin: 0 0 0.5rem 0; color: #1e40af;">💳 Complete Your InstaPay Payment</h4>
                                        <p style="margin: 0 0 0.5rem 0; font-size: 0.875rem;">Transfer ${currency}${totalAmount} to: <strong>+201141615312</strong></p>
                                        <p style="margin: 0; font-size: 0.75rem; color: #6b7280;">Your order will be confirmed once admin verifies the payment.</p>
                                    </div>
                                ` : ''}
                                
                                ${order.paymentStatus === 'confirmed' ? `
                                    <div style="margin-top: 1rem; padding: 1rem; background: #f0fdf4; border-radius: 0.5rem; border-left: 4px solid #10b981;">
                                        <h4 style="margin: 0 0 0.5rem 0; color: #065f46;">✅ Order Confirmed</h4>
                                        <p style="margin: 0; font-size: 0.875rem;">Your payment has been confirmed! Our team will contact you soon to schedule your services.</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                console.log('Orders loaded successfully:', allOrders.length);
                
            } catch (error) {
                console.error('=== ORDERS LOADING ERROR ===');
                console.error('Error object:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Current user:', currentUser);
                console.error('Auth token:', auth.currentUser);
                
                const ordersContainer = document.getElementById('ordersContainer');
                const loadingMessage = document.getElementById('ordersLoadingMessage');
                
                if (loadingMessage) {
                    loadingMessage.style.display = 'none';
                }
                
                let errorMessage = 'Unable to load your orders. Please try again later.';
                let debugInfo = '';
                
                if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied. Please make sure you are logged in and Firestore rules are deployed.';
                    debugInfo = `
                        <div style="margin-top: 1rem; padding: 1rem; background: #fef2f2; border-radius: 0.5rem; text-align: left;">
                            <h4 style="color: #dc2626; margin: 0 0 0.5rem 0;">🔧 Debug Info:</h4>
                            <p style="margin: 0; font-size: 0.875rem; font-family: monospace;">
                                Error: ${error.code}<br>
                                Message: ${error.message}<br>
                                User Email: ${currentUser?.email || 'Not available'}<br>
                                Auth Status: ${auth.currentUser ? 'Authenticated' : 'Not authenticated'}
                            </p>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: #6b7280;">
                                <strong>Fix:</strong> Run <code>firebase deploy --only firestore:rules</code> to deploy security rules.
                            </p>
                        </div>
                    `;
                } else if (error.code === 'unavailable') {
                    errorMessage = 'Firebase service is temporarily unavailable. Please check your internet connection.';
                } else if (error.code === 'unauthenticated') {
                    errorMessage = 'You need to be logged in to view your orders.';
                }
                
                ordersContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
                        <h3 style="color: #1f2937; margin-bottom: 1rem;">Error Loading Orders</h3>
                        <p style="color: #6b7280; margin-bottom: 2rem;">${errorMessage}</p>
                        <button onclick="loadOrders()" style="background: #2563eb; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer;">
                            🔄 Try Again
                        </button>
                        ${debugInfo}
                    </div>
                `;
            }
        }

        // Debug function to show all orders in database (for troubleshooting)
        window.showAllOrdersDebug = async function() {
            try {
                console.log('=== DEBUG: SHOWING ALL ORDERS IN DATABASE ===');
                
                const ordersContainer = document.getElementById('ordersContainer');
                ordersContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div class="loading">🔍 Loading all orders for debugging...</div>
                    </div>
                `;
                
                let allOrdersInDB = [];
                
                // Get ALL orders from orders collection
                try {
                    const allOrdersQuery = query(collection(db, "orders"));
                    const allOrdersSnapshot = await getDocs(allOrdersQuery);
                    console.log('Total orders in orders collection:', allOrdersSnapshot.size);
                    allOrdersSnapshot.forEach((doc) => {
                        const data = doc.data();
                        allOrdersInDB.push({ 
                            id: doc.id, 
                            collection: 'orders',
                            customerEmail: data.customerEmail,
                            ...data 
                        });
                        console.log('Order:', doc.id, 'Email:', data.customerEmail);
                    });
                } catch (error) {
                    console.error('Error loading orders collection:', error);
                }
                
                // Get ALL consultations from consultations collection
                try {
                    const allConsultationsQuery = query(collection(db, "consultations"));
                    const allConsultationsSnapshot = await getDocs(allConsultationsQuery);
                    console.log('Total consultations:', allConsultationsSnapshot.size);
                    allConsultationsSnapshot.forEach((doc) => {
                        const data = doc.data();
                        allOrdersInDB.push({ 
                            id: doc.id, 
                            collection: 'consultations',
                            userEmail: data.userEmail,
                            customerEmail: data.customerEmail,
                            email: data.email,
                            ...data 
                        });
                        console.log('Consultation:', doc.id, 'Emails:', {
                            userEmail: data.userEmail,
                            customerEmail: data.customerEmail, 
                            email: data.email
                        });
                    });
                } catch (error) {
                    console.error('Error loading consultations collection:', error);
                }
                
                console.log('Current user email:', currentUser?.email);
                console.log('Total items found:', allOrdersInDB.length);
                
                if (allOrdersInDB.length === 0) {
                    ordersContainer.innerHTML = `
                        <div style="text-align: center; padding: 3rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem;">
                            <h3 style="color: #dc2626;">🔍 Debug Results</h3>
                            <p>No orders or consultations found in either collection.</p>
                            <p style="color: #6b7280;">This means no orders have been placed yet.</p>
                            <button onclick="loadOrders()" style="background: #2563eb; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer; margin-top: 1rem;">
                                ← Back to Orders
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // Sort by timestamp (newest first)
                allOrdersInDB.sort((a, b) => {
                    const timestampA = new Date(a.timestamp || a.createdAt || 0);
                    const timestampB = new Date(b.timestamp || b.createdAt || 0);
                    return timestampB - timestampA;
                });
                
                // Show debug information
                ordersContainer.innerHTML = `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem;">
                        <h3 style="color: #dc2626; margin: 0 0 1rem 0;">🔍 Debug Mode - All Orders in Database</h3>
                        <div style="background: #fef2f2; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                            <p style="margin: 0; font-size: 0.875rem;"><strong>Your email:</strong> ${currentUser?.email}</p>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;"><strong>Total orders found:</strong> ${allOrdersInDB.length}</p>
                        </div>
                        <button onclick="loadOrders()" style="background: #2563eb; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer; margin-bottom: 1rem;">
                            ← Back to My Orders
                        </button>
                    </div>
                    ${allOrdersInDB.map(order => {
                        const isCoachingOrder = order.type === 'coaching-program-order';
                        const orderTimestamp = order.timestamp || order.createdAt;
                        const orderDate = orderTimestamp ? new Date(orderTimestamp).toLocaleDateString() : 'Unknown date';
                        
                        // Check if this order matches current user
                        const emailMatches = order.customerEmail === currentUser?.email || 
                                           order.userEmail === currentUser?.email || 
                                           order.email === currentUser?.email;
                        
                        return `
                            <div style="background: white; border: 1px solid ${emailMatches ? '#10b981' : '#e5e7eb'}; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <h4 style="margin: 0; color: #1f2937;">
                                        ${isCoachingOrder ? '🏋️‍♂️ Coaching Order' : '📞 Consultation'}
                                        ${emailMatches ? ' ✅' : ''}
                                    </h4>
                                    <span style="font-size: 0.75rem; background: ${emailMatches ? '#d1fae5' : '#f3f4f6'}; color: ${emailMatches ? '#059669' : '#6b7280'}; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">
                                        ${order.collection}
                                    </span>
                                </div>
                                <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">
                                    ID: ${order.id} | Date: ${orderDate}
                                </div>
                                <div style="font-size: 0.875rem; color: #6b7280;">
                                    ${order.customerEmail ? `Customer Email: ${order.customerEmail}` : ''}
                                    ${order.userEmail ? `User Email: ${order.userEmail}` : ''}
                                    ${order.email ? `Email: ${order.email}` : ''}
                                </div>
                                ${order.items ? `
                                    <div style="margin-top: 0.5rem; font-size: 0.875rem;">
                                        Items: ${order.items.map(item => `${item.serviceName} × ${item.quantity}`).join(', ')}
                                    </div>
                                ` : ''}
                                ${order.total ? `<div style="font-weight: 600; color: #2563eb;">Total: $${order.total}</div>` : ''}
                            </div>
                        `;
                    }).join('')}
                `;
                
            } catch (error) {
                console.error('Debug function error:', error);
                const ordersContainer = document.getElementById('ordersContainer');
                ordersContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem;">
                        <h3 style="color: #dc2626;">Debug Error</h3>
                        <p>Error loading debug information: ${error.message}</p>
                        <button onclick="loadOrders()" style="background: #2563eb; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer;">
                            ← Back to Orders
                        </button>
                    </div>
                `;
            }
        };

        // Check payment status for the user (consultations + orders)
        async function checkPaymentStatus() {
            try {
                console.log('=== CHECKING PAYMENT STATUS ===');
                console.log('Checking payment for user:', currentUser?.email);

                if (!currentUser || !currentUser.email) {
                    console.warn('No authenticated user for payment check');
                    return { hasValidPayment: false, paymentInfo: null };
                }

                let hasValidPayment = false;
                let paymentInfo = null;

                // 1) Consultations payment (legacy/free services)
                try {
                    const consultationQuery = query(
                        collection(db, "consultations"), 
                        where("userEmail", "==", currentUser.email)
                    );
                    const consultationSnapshot = await getDocs(consultationQuery);
                    console.log('Found consultations:', consultationSnapshot.size);

                    consultationSnapshot.forEach((doc) => {
                        const data = doc.data();
                        console.log('Consultation:', {
                            serviceType: data.serviceType,
                            paymentStatus: data.paymentStatus,
                            paymentMethod: data.paymentMethod
                        });

                        // Confirmed paid services
                        if ((data.serviceType === 'nutrition-plan' || data.serviceType === 'full-program') && data.paymentStatus === 'confirmed') {
                            hasValidPayment = true;
                            paymentInfo = paymentInfo || {
                                serviceType: data.serviceType,
                                paymentMethod: data.paymentMethod,
                                paymentConfirmedAt: data.paymentConfirmedAt
                            };
                        }

                        // Free consultations always allow access
                        if (data.serviceType === 'free-consultation') {
                            hasValidPayment = true;
                            paymentInfo = paymentInfo || { serviceType: 'free-consultation' };
                        }
                    });
                } catch (e) {
                    console.log('Consultations payment check failed:', e?.message || e);
                }

                // 2) Orders payment (coaching program orders)
                try {
                    const ordersQ = query(
                        collection(db, "orders"),
                        where("customerEmail", "==", currentUser.email)
                    );
                    const ordersSnap = await getDocs(ordersQ);
                    console.log('Found orders for payment check:', ordersSnap.size);

                    ordersSnap.forEach((doc) => {
                        const data = doc.data();
                        if (data.paymentStatus === 'confirmed') {
                            hasValidPayment = true;
                            if (!paymentInfo) {
                                paymentInfo = {
                                    serviceType: data.type || 'coaching-program-order',
                                    paymentMethod: data.paymentMethod,
                                    paymentConfirmedAt: data.paymentConfirmedAt || data.timestamp
                                };
                            }
                        }
                    });
                } catch (e) {
                    console.log('Orders payment check failed:', e?.message || e);
                }

                console.log('Payment status result (combined):', { hasValidPayment, paymentInfo });
                return { hasValidPayment, paymentInfo };

            } catch (error) {
                console.error('Error checking payment status:', error);
                return { hasValidPayment: false, paymentInfo: null };
            }
        }

        // Load exercises for the client
        async function loadExercises() {
            try {
                console.log('=== LOADING EXERCISES ===');
                console.log('Current user:', currentUser?.uid);
                
                if (!currentUser || !currentUser.uid) {
                    console.error('No authenticated user found');
                    throw new Error('User not authenticated');
                }

                const exercisesContainer = document.getElementById('exercisesContainer');
                const loadingMessage = document.getElementById('exercisesLoadingMessage');
                
                // Query exercises for this client
                const exercisesQuery = query(collection(db, "exercises"), where("clientUid", "==", currentUser.uid));
                const exercisesSnapshot = await getDocs(exercisesQuery);
                
                console.log('Found exercises:', exercisesSnapshot.size);
                
                if (loadingMessage) {
                    loadingMessage.style.display = 'none';
                }
                
                if (exercisesSnapshot.empty) {
                    exercisesContainer.innerHTML = `
                        <div style="text-align: center; padding: 3rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">🏋️‍♂️</div>
                            <h3 style="color: #1f2937; margin-bottom: 1rem;">No Exercises Assigned</h3>
                            <p style="color: #6b7280; margin-bottom: 2rem;">
                                Your coach hasn't assigned any exercises yet. Check back soon for your personalized workout plan!
                            </p>
                            <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 2rem;">
                                <h4 style="color: #1e40af; margin-bottom: 1rem;">📋 What to Expect:</h4>
                                <ul style="text-align: left; color: #374151; line-height: 1.6;">
                                    <li>Personalized exercise routines based on your goals</li>
                                    <li>Video demonstrations for proper form</li>
                                    <li>Detailed instructions and safety tips</li>
                                    <li>Progress tracking and adjustments</li>
                                </ul>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                const exercises = [];
                exercisesSnapshot.forEach((doc) => {
                    exercises.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Sort by creation date (newest first)
                exercises.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                exercisesContainer.innerHTML = exercises.map(exercise => {
                    const statusClass = exercise.status === 'active' ? 'active' : 
                                       exercise.status === 'completed' ? 'completed' : 'inactive';
                    const statusText = exercise.status === 'active' ? 'Active' : 
                                      exercise.status === 'completed' ? 'Completed' : 'Inactive';
                    
                    return `
                        <div class="exercise-card">
                            <div class="exercise-header">
                                <div style="flex: 1;">
                                    <h3 class="exercise-title">
                                        🏋️‍♂️ ${exercise.exerciseName}
                                    </h3>
                                    <div class="exercise-meta">
                                        Category: ${exercise.category}
                                    </div>
                                    <div class="exercise-meta">
                                        Assigned: ${new Date(exercise.createdAt).toLocaleDateString()}
                                    </div>
                                </div>
                                <div class="exercise-stats">
                                    <div class="exercise-status ${statusClass}">
                                        ${statusText}
                                    </div>
                                    <div class="exercise-sets-reps">
                                        ${exercise.sets} × ${exercise.reps}
                                    </div>
                                    <div class="exercise-sets-reps-label">
                                        Sets × Reps
                                    </div>
                                </div>
                            </div>
                            
                            <div class="exercise-content">
                                ${exercise.description ? `
                                <div class="exercise-section">
                                    <h4 class="exercise-section-title">📝 Instructions</h4>
                                    <p class="exercise-description">${exercise.description}</p>
                                </div>
                                ` : ''}
                                
                                ${exercise.notes ? `
                                <div class="exercise-section">
                                    <h4 class="exercise-section-title">📋 Notes</h4>
                                    <p class="exercise-notes">${exercise.notes}</p>
                                </div>
                                ` : ''}
                                
                                ${exercise.videoFile ? `
                                <div class="exercise-section">
                                    <h4 class="exercise-section-title">🎥 Video Demonstration</h4>
                                    <div class="exercise-video">
                                        <div class="exercise-video-header">
                                            <i class="fas fa-video" style="color: #0ea5e9;"></i>
                                            <span style="font-weight: 600;">${exercise.videoFile}</span>
                                        </div>
                                        <p class="exercise-video-text">
                                            Watch the video demonstration to learn proper form and technique for this exercise.
                                        </p>
                                        <button onclick="console.log('Button clicked, videoFile:', '${exercise.videoFile}'); viewExerciseVideo('${exercise.videoFile}')" class="btn btn-primary" style="margin-top: 0.75rem;">
                                            <i class="fas fa-play"></i> Watch Video
                                        </button>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="exercise-actions">
                                <button onclick="markExerciseComplete('${exercise.id}')" 
                                        class="exercise-btn exercise-btn-complete"
                                        ${exercise.status === 'completed' ? 'disabled' : ''}>
                                    <i class="fas fa-check"></i>
                                    ${exercise.status === 'completed' ? 'Completed' : 'Mark Complete'}
                                </button>
                                <button onclick="viewExerciseDetails('${exercise.id}')" 
                                        class="exercise-btn exercise-btn-view">
                                    <i class="fas fa-eye"></i>
                                    View Details
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                console.log('Exercises loaded successfully:', exercises.length);
                
            } catch (error) {
                console.error('=== EXERCISES LOADING ERROR ===');
                console.error('Error object:', error);
                console.error('Error message:', error.message);
                console.error('Current user:', currentUser);
                
                const exercisesContainer = document.getElementById('exercisesContainer');
                const loadingMessage = document.getElementById('exercisesLoadingMessage');
                
                if (loadingMessage) {
                    loadingMessage.style.display = 'none';
                }
                
                let errorMessage = 'Error loading exercises. Please try again.';
                
                if (error.message === 'User not authenticated') {
                    errorMessage = 'Please log in to view your exercises.';
                } else if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied. Firestore rules need to be deployed.';
                } else if (error.code) {
                    errorMessage = `Database error (${error.code}): ${error.message}`;
                }
                
                exercisesContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #dc2626; border: 1px solid #fecaca; border-radius: 0.5rem; background: #fef2f2;">
                        <h3 style="margin: 0 0 1rem 0; color: #dc2626;">🚨 Loading Error</h3>
                        <p style="margin-bottom: 0.5rem;"><strong>${errorMessage}</strong></p>
                        <button onclick="loadExercises()" style="padding: 0.5rem 1rem; background: #2563eb; color: white; border: none; border-radius: 0.25rem; cursor: pointer;">
                            🔄 Retry
                        </button>
                    </div>
                `;
            }
        }

        // Mark exercise as complete
        async function markExerciseComplete(exerciseId) {
            try {
                console.log('Marking exercise complete:', exerciseId);
                
                if (!currentUser) {
                    showMessage('Please log in to mark exercises complete.', 'error');
                    return;
                }
                
                // Update exercise status in Firebase
                const exerciseRef = doc(db, "exercises", exerciseId);
                await updateDoc(exerciseRef, {
                    status: 'completed',
                    completedAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
                
                showMessage('Exercise marked as complete! Great job! 🎉', 'success');
                
                // Refresh exercises display
                await loadExercises();
                
            } catch (error) {
                console.error('Error marking exercise complete:', error);
                showMessage('Failed to mark exercise complete. Please try again.', 'error');
            }
        }

        // View exercise details in a modal
        async function viewExerciseDetails(exerciseId) {
            try {
                console.log('Viewing exercise details:', exerciseId);
                
                // Get exercise data from Firebase
                const exerciseRef = doc(db, "exercises", exerciseId);
                const exerciseDoc = await getDoc(exerciseRef);
                
                if (!exerciseDoc.exists()) {
                    showMessage('Exercise not found.', 'error');
                    return;
                }
                
                const exercise = exerciseDoc.data();
                
                // Create modal
                const modal = document.createElement('div');
                modal.id = 'exerciseDetailsModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: fadeIn 0.3s ease;
                `;

                modal.innerHTML = `
                    <div style="background: white; border-radius: 1rem; padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb;">
                            <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem;">🏋️‍♂️ ${exercise.exerciseName}</h3>
                            <button onclick="closeExerciseDetailsModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">&times;</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #2563eb;">${exercise.sets}</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Sets</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #059669;">${exercise.reps}</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Reps</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #d97706;">${exercise.category}</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Category</div>
                            </div>
                        </div>
                        
                        ${exercise.description ? `
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 0.75rem 0; color: #374151;">📝 Instructions</h4>
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #2563eb;">
                                <p style="margin: 0; color: #374151; line-height: 1.6;">${exercise.description}</p>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${exercise.notes ? `
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 0.75rem 0; color: #374151;">📋 Notes</h4>
                            <div style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #f59e0b;">
                                <p style="margin: 0; color: #92400e; line-height: 1.6;">${exercise.notes}</p>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${exercise.videoFile ? `
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 0.75rem 0; color: #374151;">🎥 Video Demonstration</h4>
                            <div style="background: #f0f9ff; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #0ea5e9;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; color: #0c4a6e; margin-bottom: 0.75rem;">
                                    <i class="fas fa-video" style="color: #0ea5e9;"></i>
                                    <span style="font-weight: 600;">${exercise.videoFile}</span>
                                </div>
                                <p style="margin: 0 0 0.75rem; font-size: 0.875rem; color: #0c4a6e;">
                                    Watch the video demonstration to learn proper form and technique for this exercise.
                                </p>
                                <button onclick="console.log('Modal button clicked, videoFile:', '${exercise.videoFile}'); viewExerciseVideo('${exercise.videoFile}')" style="background: #0ea5e9; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-play"></i> Watch Video
                                </button>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                            <button onclick="markExerciseComplete('${exerciseId}')" 
                                    style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;"
                                    ${exercise.status === 'completed' ? 'disabled' : ''}>
                                <i class="fas fa-check"></i>
                                ${exercise.status === 'completed' ? 'Completed' : 'Mark Complete'}
                            </button>
                            <button onclick="closeExerciseDetailsModal()" 
                                    style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                                Close
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error viewing exercise details:', error);
                showMessage('Failed to load exercise details. Please try again.', 'error');
            }
        }

        // Close exercise details modal
        function closeExerciseDetailsModal() {
            const modal = document.getElementById('exerciseDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle video loading errors
        function handleVideoError(videoElement, videoFile) {
            videoElement.style.display = 'none';
            const container = videoElement.parentElement;
            container.innerHTML = `
                <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 0.5rem; padding: 1rem; text-align: center;">
                    <div style="color: #dc2626; font-size: 1.5rem; margin-bottom: 0.5rem;">⚠️</div>
                    <p style="margin: 0; color: #dc2626; font-size: 0.875rem;">
                        Video file "${videoFile}" not found. Please contact your coach.
                    </p>
                </div>
            `;
        }

        // View exercise video in modal (same as admin dashboard)
        function viewExerciseVideo(videoFile) {
            console.log('viewExerciseVideo called with:', videoFile);
            
            try {
                if (!videoFile) {
                    alert('No video file specified for this exercise.');
                    return;
                }
                
                // Create a modal to show the video
                const videoModal = document.createElement('div');
                videoModal.className = 'modal active';
                videoModal.style.cssText = `
                    display: flex;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    z-index: 2000;
                    align-items: center;
                    justify-content: center;
                    -webkit-overflow-scrolling: touch;
                `;
                
                // Get base filename for multiple format support
                const baseName = videoFile.replace(/\.[^/.]+$/, '');
                
                videoModal.innerHTML = `
                    <div style="background: white; border-radius: 1rem; padding: 1rem; max-width: 800px; width: 95%; max-height: 95vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; color: #1f2937; font-size: 1.25rem;">Exercise Video: ${videoFile}</h3>
                            <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; padding: 0.5rem; -webkit-tap-highlight-color: transparent;">&times;</button>
                        </div>
                        <div style="background: #000; border-radius: 0.5rem; position: relative; margin-bottom: 1rem;">
                            <video 
                                controls 
                                playsinline 
                                webkit-playsinline 
                                style="width: 100%; border-radius: 0.5rem; display: block;" 
                                preload="metadata" 
                                poster=""
                                muted="false"
                                autoplay="false"
                                webkit-playsinline="true"
                                x-webkit-airplay="allow"
                                controlsList="nodownload">
                                <!-- Safari prefers MP4 with H.264 codec first -->
                                <source src="videos/${baseName}.mp4" type="video/mp4; codecs=\"avc1.42E01E, mp4a.40.2\"">
                                <source src="videos/${baseName}.m4v" type="video/mp4">
                                <!-- Original file as fallback -->
                                <source src="videos/${videoFile}" type="video/webm">
                                <source src="videos/${baseName}.mov" type="video/quicktime">
                                <source src="videos/${baseName}.3gp" type="video/3gpp">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                        <p style="color: #6b7280; font-size: 0.875rem; text-align: center; margin: 0;">
                            Safari requires MP4 format. If video doesn't play, ensure "${baseName}.mp4" exists in the videos folder.
                        </p>
                    </div>
                `;
                
                document.body.appendChild(videoModal);
                
                // Safari-specific video handling
                const video = videoModal.querySelector('video');
                if (video) {
                    // Safari-specific event listeners
                    video.addEventListener('loadstart', () => {
                        console.log('Video load started');
                    });
                    
                    video.addEventListener('loadedmetadata', () => {
                        console.log('Video metadata loaded successfully');
                    });
                    
                    video.addEventListener('loadeddata', () => {
                        console.log('Video data loaded');
                    });
                    
                    video.addEventListener('canplay', () => {
                        console.log('Video can play');
                    });
                    
                    video.addEventListener('canplaythrough', () => {
                        console.log('Video can play through without buffering');
                    });
                    
                    video.addEventListener('error', (e) => {
                        console.error('Video error:', e);
                        console.error('Video error details:', video.error);
                        
                        const errorDiv = document.createElement('div');
                        errorDiv.style.cssText = `
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            background: rgba(255, 0, 0, 0.8);
                            color: white;
                            padding: 1rem;
                            border-radius: 0.5rem;
                            text-align: center;
                            max-width: 80%;
                        `;
                        
                        let errorMessage = 'Unable to load video';
                        if (video.error) {
                            switch(video.error.code) {
                                case 1:
                                    errorMessage = 'Video loading aborted';
                                    break;
                                case 2:
                                    errorMessage = 'Network error loading video';
                                    break;
                                case 3:
                                    errorMessage = 'Video decoding failed';
                                    break;
                                case 4:
                                    errorMessage = 'Video format not supported';
                                    break;
                            }
                        }
                        
                        errorDiv.innerHTML = `
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">⚠️</div>
                            <p style="margin: 0; font-size: 1rem;">${errorMessage}</p>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">File: ${videoFile}</p>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: #ffeb3b;">Safari requires MP4 format with H.264 codec</p>
                        `;
                        video.parentElement.appendChild(errorDiv);
                    });
                    
                    // Force video to load on Safari
                    video.load();
                }
                
                // Close modal when clicking outside
                videoModal.addEventListener('click', (e) => {
                    if (e.target === videoModal) {
                        videoModal.remove();
                    }
                });
                
                console.log('Video modal created successfully');
                
            } catch (error) {
                console.error('Error creating video modal:', error);
                alert('Error opening video. Please try again.');
            }
        }

        // Make viewExerciseVideo globally accessible
        window.viewExerciseVideo = viewExerciseVideo;
        
        // Test function to verify video modal works
        window.testVideoModal = function() {
            console.log('Testing video modal...');
            viewExerciseVideo('test-video.webm');
        };

        // Load nutrition plans for the client
        async function loadNutritionPlans() {
            try {
                // Enhanced debugging for authentication and query
                console.log('=== NUTRITION PLANS LOADING DEBUG ===');
                console.log('1. Current user object:', currentUser);
                console.log('2. Database connection:', db);
                console.log('3. User UID:', currentUser?.uid);
                console.log('4. User email:', currentUser?.email);
                console.log('5. Auth state:', auth.currentUser);
                
                // Check if user is authenticated
                if (!currentUser || !currentUser.uid) {
                    console.error('No authenticated user found or missing UID');
                    throw new Error('User not authenticated');
                }

                // First, check payment status
                const { hasValidPayment, paymentInfo } = await checkPaymentStatus();
                
                if (!hasValidPayment) {
                    console.log('User does not have valid payment, showing payment required message');
                    const nutritionContainer = document.getElementById('nutritionPlansContainer');
                    const loadingMessage = document.getElementById('nutritionLoadingMessage');
                    
                    if (loadingMessage) {
                        loadingMessage.style.display = 'none';
                    }
                    
                    nutritionContainer.innerHTML = `
                        <div style="text-align: center; padding: 3rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">💳</div>
                            <h3 style="color: #1f2937; margin-bottom: 1rem;">Payment Required</h3>
                            <p style="color: #6b7280; margin-bottom: 2rem;">
                                To access your nutrition plans, please complete your payment for the service you requested.
                            </p>
                            <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 2rem;">
                                <h4 style="color: #1e40af; margin-bottom: 1rem;">📋 How to Complete Payment:</h4>
                                <ol style="text-align: left; color: #374151; line-height: 1.6;">
                                    <li>Check your email for payment instructions</li>
                                    <li>Complete the payment using your selected method</li>
                                    <li>Wait for admin confirmation (usually within 24 hours)</li>
                                    <li>Once confirmed, refresh this page to access your nutrition plans</li>
                                </ol>
                            </div>
                            <button onclick="window.location.reload()" style="background: #2563eb; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 1rem;">
                                🔄 Refresh Page
                            </button>
                        </div>
                    `;
                    return;
                }
                
                console.log('User has valid payment, loading nutrition plans...', paymentInfo);
                
                console.log('6. Building query for clientUid:', currentUser.uid);
                
                // Test basic Firestore connection first
                try {
                    const testQuery = query(collection(db, "nutritionPlans"));
                    console.log('7. Testing basic Firestore connection...');
                    const testSnapshot = await getDocs(testQuery);
                    console.log('8. Basic connection successful. Total nutrition plans:', testSnapshot.size);
                    
                    // Log all nutrition plans to see their structure
                    testSnapshot.forEach((doc) => {
                        const data = doc.data();
                        console.log('9. Found nutrition plan:', {
                            id: doc.id,
                            clientUid: data.clientUid,
                            clientName: data.clientName,
                            planName: data.planName
                        });
                    });
                } catch (testError) {
                    console.error('10. Basic Firestore connection failed:', testError);
                    throw testError;
                }
                
                console.log('11. Running filtered query for user:', currentUser.uid);
                const nutritionQuery = query(collection(db, "nutritionPlans"), where("clientUid", "==", currentUser.uid));
                const nutritionSnapshot = await getDocs(nutritionQuery);
                console.log('12. Filtered query result - size:', nutritionSnapshot.size);
                
                const nutritionContainer = document.getElementById('nutritionPlansContainer');
                const loadingMessage = document.getElementById('nutritionLoadingMessage');
                
                if (nutritionSnapshot.empty) {
                    nutritionContainer.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #6b7280;">
                            <p>No nutrition plans assigned yet.</p>
                            <p>Your coach will create a personalized nutrition plan for you soon!</p>
                        </div>
                    `;
                    return;
                }

                if (loadingMessage) {
                loadingMessage.style.display = 'none';
                } else {
                    console.error('❌ loadingMessage element not found');
                }
                
                const plans = [];
                nutritionSnapshot.forEach((doc) => {
                    plans.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Sort by creation date (newest first)
                plans.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                // Debug: Log meal plan structure
                console.log('13. Nutrition plans structure:');
                plans.forEach((plan, index) => {
                    console.log(`Plan ${index + 1}:`, {
                        id: plan.id,
                        planName: plan.planName,
                        mealPlan: plan.mealPlan,
                        mealPlanType: typeof plan.mealPlan,
                        mealPlanKeys: plan.mealPlan ? Object.keys(plan.mealPlan) : 'null'
                    });
                    
                    if (plan.mealPlan) {
                        Object.entries(plan.mealPlan).forEach(([mealType, items]) => {
                            console.log(`  ${mealType}:`, {
                                items: items,
                                isArray: Array.isArray(items),
                                length: items ? items.length : 'null',
                                type: typeof items
                            });
                        });
                    }
                });
                
                nutritionContainer.innerHTML = plans.map(plan => `
                    <div class="nutrition-plan-card" style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; color: #1f2937;">${plan.planName}</h3>
                            <span class="status-badge" style="padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 500; background: ${plan.status === 'active' ? '#d1fae5' : '#fef3c7'}; color: ${plan.status === 'active' ? '#059669' : '#d97706'};">${plan.status}</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #2563eb;">${plan.dailyCalories}</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Daily Calories</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #059669;">${plan.dailyProtein}g</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Daily Protein</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #d97706;">${plan.dailyCarbs}g</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Daily Carbs</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #dc2626;">${plan.dailyFat}g</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Daily Fat</div>
                            </div>
                        </div>
                        
                        ${plan.planDescription ? `
                        <div style="margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #374151;">Description</h4>
                            <p style="margin: 0; color: #6b7280;">${plan.planDescription}</p>
                        </div>
                        ` : ''}
                        
                        <div style="margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #374151;">Meal Plan</h4>
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${renderMealPlan(plan)}
                            </div>
                        </div>
                        
                        ${plan.planNotes ? `
                        <div style="margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #374151;">Notes</h4>
                            <p style="margin: 0; color: #6b7280;">${plan.planNotes}</p>
                        </div>
                        ` : ''}
                        
                        <div style="font-size: 0.875rem; color: #6b7280;">
                            Created: ${new Date(plan.createdAt).toLocaleDateString()}
                        </div>
                    </div>
                `).join('');

                // Store plans globally for replacement functionality
                nutritionPlans = plans;
                console.log('Stored nutrition plans globally:', nutritionPlans.length, 'plans');
                
                // Add event listeners to replace buttons
                setupReplaceButtonListeners();
                
            } catch (error) {
                console.error('=== NUTRITION PLANS ERROR DETAILS ===');
                console.error('Error object:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Current user:', currentUser);
                console.error('User auth token:', currentUser?.accessToken);
                console.error('Database:', db);
                console.error('Firebase Auth:', auth);
                console.error('Auth current user:', auth.currentUser);
                
                let errorMessage = 'Error loading nutrition plans. Please try again.';
                let debugInfo = '';
                
                if (error.message === 'User not authenticated') {
                    errorMessage = 'Please log in to view your nutrition plans.';
                    debugInfo = 'Authentication issue detected.';
                } else if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied. Firestore rules need to be deployed.';
                    debugInfo = `Deploy rules with: firebase deploy --only firestore:rules`;
                } else if (error.code) {
                    errorMessage = `Database error: ${error.code}. Please try again.`;
                    debugInfo = `Error code: ${error.code}`;
                } else {
                    debugInfo = `Unknown error: ${error.message}`;
                }
                
                document.getElementById('nutritionPlansContainer').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #dc2626; border: 1px solid #fecaca; border-radius: 0.5rem; background: #fef2f2;">
                        <h3 style="margin: 0 0 1rem 0; color: #dc2626;">🚨 Loading Error</h3>
                        <p style="margin-bottom: 0.5rem;"><strong>${errorMessage}</strong></p>
                        <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem;">${debugInfo}</p>
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button onclick="loadNutritionPlans()" style="padding: 0.5rem 1rem; background: #2563eb; color: white; border: none; border-radius: 0.25rem; cursor: pointer;">
                                🔄 Retry
                            </button>
                            <button onclick="window.location.reload()" style="padding: 0.5rem 1rem; background: #059669; color: white; border: none; border-radius: 0.25rem; cursor: pointer;">
                                🔃 Reload Page
                            </button>
                            <button onclick="testFirebaseConnection()" style="padding: 0.5rem 1rem; background: #7c3aed; color: white; border: none; border-radius: 0.25rem; cursor: pointer;">
                                🔍 Test Firebase
                            </button>
                        </div>
                        <details style="margin-top: 1rem; text-align: left;">
                            <summary style="cursor: pointer; color: #6b7280;">Click for Technical Details</summary>
                            <pre style="background: #f9fafb; padding: 1rem; border-radius: 0.25rem; overflow-x: auto; margin-top: 0.5rem; font-size: 0.75rem;">${JSON.stringify({
                                errorCode: error.code,
                                errorMessage: error.message,
                                userUID: currentUser?.uid,
                                userEmail: currentUser?.email,
                                authState: !!auth.currentUser,
                                timestamp: new Date().toISOString()
                            }, null, 2)}</pre>
                        </details>
                    </div>
                `;
            }
        }

        // Show message
        function showMessage(message, type = 'success') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messagesContainer.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Login form handler
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const email = formData.get('email');
                const password = formData.get('password');

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage('Login successful!', 'success');
                } catch (error) {
                    console.error('Login error:', error);
                    let errorMessage = 'Login failed. Please try again.';
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = 'No account found with this email.';
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Incorrect password.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Please enter a valid email address.';
                    }
                    showMessage(errorMessage, 'error');
                }
            });

            // Logout handler
            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    showMessage('Logged out successfully.', 'success');
                } catch (error) {
                    console.error('Logout error:', error);
                    showMessage('Logout failed. Please try again.', 'error');
                }
            });

            // Profile form handler
            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const newWeight = parseFloat(formData.get('weight'));

                if (!newWeight || newWeight < 30 || newWeight > 300) {
                    showMessage('Please enter a valid weight between 30-300 kg.', 'error');
                    return;
                }

                try {
                    // Update weight in clients collection
                    await updateDoc(doc(db, "clients", userData.id), {
                        weight: newWeight,
                        updatedAt: new Date().toISOString()
                    });

                    // Update local data
                    userData.weight = newWeight;
                    updateDashboard();
                    showMessage('Weight updated successfully!', 'success');
                } catch (error) {
                    console.error('Error updating weight:', error);
                    showMessage('Failed to update weight. Please try again.', 'error');
                }
            });
        });
        // Food replacement modal and functionality
        let currentReplacementContext = null;
        let nutritionPlans = [];

        // Render meal plan (handles both single-day and multi-day formats)
        function renderMealPlan(plan) {
            const mealPlan = plan.mealPlan || {};
            
            // Check if this is a multi-day meal plan (new format)
            const isMultiDay = Object.keys(mealPlan).some(key => !isNaN(key));
            
            if (isMultiDay) {
                // Multi-day format: { 1: {breakfast: [...], lunch: [...], dinner: [...]}, 2: {...}, ... }
                console.log('Rendering multi-day meal plan');
                return Object.entries(mealPlan)
                    .sort(([dayA], [dayB]) => parseInt(dayA) - parseInt(dayB))
                    .map(([day, dayMeals]) => `
                        <div class="day-meal-plan">
                            <div class="day-header">
                                <h5 style="margin: 0; color: #374151; font-weight: 600;">📅 Day ${day}</h5>
                            </div>
                            <div style="padding: 1rem;">
                                ${renderDayMeals(dayMeals, plan.id, day)}
                            </div>
                        </div>
                    `).join('');
            } else {
                // Single-day format: { breakfast: [...], lunch: [...], dinner: [...] }
                console.log('Rendering single-day meal plan');
                return `
                    <div style="border: 1px solid #e5e7eb; border-radius: 0.5rem; background: white; padding: 1rem;">
                        ${renderDayMeals(mealPlan, plan.id, 1)}
                    </div>
                `;
            }
        }

        function renderDayMeals(dayMeals, planId, day) {
            const mealTypes = ['breakfast', 'lunch', 'dinner'];
            const mealIcons = { breakfast: '🌅', lunch: '☀️', dinner: '🌙' };
            
            return mealTypes.map(mealType => {
                const items = dayMeals[mealType] || [];
                const isArray = Array.isArray(items);
                
                return `
                    <div class="meal-section">
                        <h6 class="meal-header">
                            ${mealIcons[mealType]} ${mealType.charAt(0).toUpperCase() + mealType.slice(1)}
                        </h6>
                        ${isArray && items.length > 0 ? items.map((item, itemIndex) => {
                            // Format serving amount and unit for display
                            const servingAmount = item.servingAmount || 100;
                            const servingUnit = item.servingUnit || 'grams';
                            const servingDisplay = servingUnit === 'grams' ? `${servingAmount}g` : 
                                                 servingUnit === 'pieces' ? `${servingAmount} pcs` :
                                                 servingUnit === 'cups' ? `${servingAmount} cup${servingAmount !== 1 ? 's' : ''}` :
                                                 servingUnit === 'tablespoons' ? `${servingAmount} tbsp` :
                                                 `${servingAmount} ${servingUnit}`;
                            
                            // Find ingredient information from food database
                            const foodName = item.food || item.name || 'Unknown Food';
                            const foodData = foodDatabase.find(f => f.name === foodName);
                            const ingredients = foodData?.ingredients || item.ingredients;
                            
                            return `
                            <div class="food-item-grid" style="position: relative;">
                                <span style="font-weight: 500; display: flex; align-items: center;">
                                    ${servingDisplay} ${foodName}
                                    ${ingredients ? '<span style="color: #3b82f6; font-size: 0.7rem; margin-left: 0.25rem; cursor: help;" title="' + ingredients.replace(/"/g, '&quot;') + '">🥄</span>' : ''}
                                </span>
                                <span>${item.calories || 0} cal</span>
                                <span>${item.protein || 0}g protein</span>
                                <span>${item.carbs || 0}g carbs</span>
                                <span>${item.fat || 0}g fat</span>
                                <button 
                                    class="replace-food-btn" 
                                    title="Replace with similar food"
                                    data-plan-id="${planId}"
                                    data-meal-type="${mealType}"
                                    data-item-index="${itemIndex}"
                                    data-current-food="${(item.food || item.name || 'Unknown')}"
                                    data-calories="${item.calories || 0}"
                                    data-protein="${item.protein || 0}"
                                    data-carbs="${item.carbs || 0}"
                                    data-fat="${item.fat || 0}"
                                    data-day="${day}"
                                >
                                    🔄 Replace
                                </button>
                                ${ingredients ? `
                                <div style="grid-column: span 6; margin-top: 0.5rem; padding: 0.5rem; background: #f8fafc; border-radius: 0.375rem; border-left: 3px solid #3b82f6; font-size: 0.75rem;">
                                    <div style="font-weight: 600; color: #374151; margin-bottom: 0.25rem;">🥄 Ingredients (per serving):</div>
                                    <div style="color: #6b7280; line-height: 1.3;">
                                        ${ingredients}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            `;
                        }).join('') : `
                            <div class="empty-meal">
                                <p style="margin: 0;">No foods planned for ${mealType}</p>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        // Test ingredient display in replacement modal
        function testIngredientDisplay() {
            console.log('🧪 Testing ingredient display...');
            
            // Find a food with ingredients
            const hummus = foodDatabase.find(f => f.name === 'Hummus');
            const falafel = foodDatabase.find(f => f.name === 'Falafel');
            const fulMedames = foodDatabase.find(f => f.name === 'Ful Medames');
            
            console.log('📋 Food Database Samples:');
            console.log('Hummus ingredients:', hummus?.ingredients);
            console.log('Falafel ingredients:', falafel?.ingredients);
            console.log('Ful Medames ingredients:', fulMedames?.ingredients);
            
            // Test the replacement modal with a sample food
            if (hummus && hummus.ingredients) {
                console.log('✅ Found foods with ingredients in database');
                console.log('🔍 To test replacement modal: Replace any food in your meal plan and look for Arabic/Egyptian options');
                showMessage('✅ Ingredient system is ready! Test by replacing any food in your meal plan.', 'success');
            } else {
                console.log('❌ No ingredients found in database');
                showMessage('❌ Ingredient data not loaded properly.', 'error');
            }
        }
        
        // Test intelligent replacement system
        function testIntelligentReplacement() {
            console.log('🧠 Testing intelligent replacement system...');
            
            // Example: 200g Mahshi Waraq Enab equivalent to other foods
            const mahshiWataqEnab = foodDatabase.find(f => f.name === 'Mahshi Waraq Enab');
            if (mahshiWataqEnab) {
                // Simulate 200g serving
                const targetNutrition = {
                    calories: mahshiWataqEnab.calories * 2, // 200g = 2 x 100g
                    protein: mahshiWataqEnab.protein * 2,
                    carbs: mahshiWataqEnab.carbs * 2,
                    fat: mahshiWataqEnab.fat * 2
                };
                
                console.log('🍽️ Target nutrition for 200g Mahshi Waraq Enab:', targetNutrition);
                
                // Find equivalent foods
                const equivalents = findSimilarFoods(targetNutrition, 'balanced', true);
                
                console.log('🎯 Top 5 equivalent foods:');
                equivalents.slice(0, 5).forEach((food, index) => {
                    console.log(`${index + 1}. ${food.equivalentDisplay} ${food.name} (${food.nutritionalEquivalence}% match)`);
                    console.log(`   Nutrition: ${food.calories}cal, ${food.protein}g protein, ${food.carbs}g carbs, ${food.fat}g fat`);
                });
                
                showMessage('🧠 Intelligent replacement system tested! Check console for equivalents.', 'success');
            } else {
                console.log('❌ Mahshi Waraq Enab not found in database');
                showMessage('❌ Test food not found in database.', 'error');
            }
        }

        // Test accurate nutritional calculations
        function testNutritionalAccuracy() {
            console.log('🔬 Testing nutritional calculation accuracy...');
            
            // Test 1: Popcorn calculation
            const popcorn = foodDatabase.find(f => f.name.includes('Popcorn'));
            if (popcorn) {
                const calories300g = popcorn.calories * 3; // 300g = 3 x 100g
                console.log(`✅ Popcorn Test: 300g of ${popcorn.name}`);
                console.log(`   Per 100g: ${popcorn.calories} calories`);
                console.log(`   For 300g: ${calories300g} calories`);
                console.log(`   Expected: ~345 calories (user's target)`);
                console.log(`   Status: ${calories300g > 200 && calories300g < 500 ? '✅ REASONABLE' : '❌ NEEDS REVIEW'}`);
            }
            
            // Test 2: Rice calculation
            const rice = foodDatabase.find(f => f.name.includes('White Rice'));
            if (rice) {
                const calories150g = Math.round(rice.calories * 1.5); // 150g = 1.5 x 100g
                console.log(`✅ Rice Test: 150g of ${rice.name}`);
                console.log(`   Per 100g: ${rice.calories} calories`);
                console.log(`   For 150g: ${calories150g} calories`);
                console.log(`   Expected: ~195 calories (USDA standard)`);
                console.log(`   Status: ${calories150g > 150 && calories150g < 250 ? '✅ REASONABLE' : '❌ NEEDS REVIEW'}`);
            }
            
            // Test 3: Intelligent replacement bounds
            const testFood = { calories: 100, protein: 10, carbs: 20, fat: 5 };
            const testTarget = { calories: 1000, protein: 100, carbs: 200, fat: 50 }; // 10x higher
            const equivalent = calculateEquivalentServing(testTarget, testFood, 'balanced');
            
            console.log(`✅ Bounds Test: Extreme 10x multiplier`);
            console.log(`   Calculated multiplier: ${equivalent.multiplier}`);
            console.log(`   Expected: Between 0.3 and 3.0 (safety bounds)`);
            console.log(`   Status: ${equivalent.multiplier >= 0.3 && equivalent.multiplier <= 3 ? '✅ BOUNDED CORRECTLY' : '❌ UNBOUNDED ERROR'}`);
            
            showMessage('🔬 Nutritional accuracy test complete! Check console for results.', 'success');
        }

        // Test recently fixed foods
        function testRecentlyFixedFoods() {
            console.log('🔧 Testing recently fixed foods...');
            
            // Test fixed foods
            const fixedFoods = [
                { name: 'Popcorn (Air-popped)', expectedCalories: 115, tolerance: 10 },
                { name: 'Seitan', expectedCalories: 125, tolerance: 25 },
                { name: 'Garlic', expectedCalories: 42, tolerance: 10 },
                { name: 'Eggs', expectedCalories: 140, tolerance: 15, serving: '2 pieces' },
                { name: 'Lean Beef', expectedCalories: 186, tolerance: 20 },
                { name: 'Lamb', expectedCalories: 250, tolerance: 25 },
                { name: 'Oatmeal (cooked)', expectedCalories: 68, tolerance: 10 },
                { name: 'Whole Wheat Bread', expectedCalories: 160, tolerance: 15, serving: '2 pieces' },
                { name: 'Olive Oil', expectedCalories: 119, tolerance: 10, serving: '1 tablespoon' },
                { name: 'Peanut Butter', expectedCalories: 190, tolerance: 15, serving: '2 tablespoons' },
                { name: 'Almonds', expectedCalories: 174, tolerance: 15, serving: '30g' },
                { name: 'Walnuts', expectedCalories: 196, tolerance: 15, serving: '30g' },
                { name: 'Chia Seeds', expectedCalories: 73, tolerance: 10, serving: '15g' },
                { name: 'Pumpkin Seeds', expectedCalories: 168, tolerance: 15, serving: '30g' },
                { name: 'Sunflower Seeds', expectedCalories: 175, tolerance: 15, serving: '30g' },
                { name: 'Cheddar Cheese', expectedCalories: 121, tolerance: 15, serving: '30g' },
                { name: 'Mozzarella', expectedCalories: 84, tolerance: 10, serving: '30g' },
                { name: 'Parmesan', expectedCalories: 86, tolerance: 10, serving: '20g' },
                { name: 'Turmeric', expectedCalories: 7, tolerance: 2, serving: '2g' },
                { name: 'Sumac', expectedCalories: 10, tolerance: 3, serving: '3g' },
                { name: 'Dark Chocolate (70%)', expectedCalories: 164, tolerance: 20, serving: '30g' },
                { name: 'Za\'atar', expectedCalories: 14, tolerance: 3, serving: '5g' },
                { name: 'Baharat (7 Spice)', expectedCalories: 9, tolerance: 2, serving: '3g' },
                { name: 'Halva', expectedCalories: 141, tolerance: 15, serving: '30g' },
                { name: 'Jibneh Arabieh (Arabic Cheese)', expectedCalories: 140, tolerance: 15, serving: '50g' },
                { name: 'Medjool Dates', expectedCalories: 199, tolerance: 25, serving: '3 pieces' }
            ];
            
            console.log('📊 Verification Results:');
            fixedFoods.forEach(test => {
                const food = foodDatabase.find(f => f.name === test.name || f.name.includes(test.name.split(' ')[0]));
                if (food) {
                    const diff = Math.abs(food.calories - test.expectedCalories);
                    const status = diff <= test.tolerance ? '✅ GOOD' : '❌ NEEDS REVIEW';
                    const serving = test.serving || 'per 100g';
                    
                    console.log(`${status} ${food.name}: ${food.calories} cal ${serving}`);
                    console.log(`   Expected: ${test.expectedCalories} cal (±${test.tolerance})`);
                    console.log(`   Difference: ${diff} cal`);
                } else {
                    console.log(`❌ NOT FOUND: ${test.name}`);
                }
            });
            
            // Count total foods that still need verification
            const totalFoods = foodDatabase.length;
            const verifiedFoods = 48; // Updated count of manually verified foods (added 6 more)
            const percentageComplete = Math.round((verifiedFoods / totalFoods) * 100);
            
            console.log(`\n📈 Database Status:`);
            console.log(`   Total Foods: ${totalFoods}`);
            console.log(`   Verified: ${verifiedFoods} (~${percentageComplete}%)`);
            console.log(`   Still Need Review: ${totalFoods - verifiedFoods} (~${100 - percentageComplete}%)`);
            
            showMessage(`🔧 Recently fixed foods tested! Database is ${percentageComplete}% verified. Check console for details.`, 'info');
        }
        
        // Make test functions globally accessible
        window.testIngredientDisplay = testIngredientDisplay;
        window.testIntelligentReplacement = testIntelligentReplacement;
        window.testNutritionalAccuracy = testNutritionalAccuracy;
        window.testRecentlyFixedFoods = testRecentlyFixedFoods;
        
        // Make exercise functions globally accessible
        window.loadExercises = loadExercises;
        window.markExerciseComplete = markExerciseComplete;
        window.viewExerciseDetails = viewExerciseDetails;
        window.closeExerciseDetailsModal = closeExerciseDetailsModal;

        // Test Firebase connectivity
        async function testFirebaseConnection() {
            console.log('=== TESTING FIREBASE CONNECTION ===');
            try {
                // Test 1: Check authentication
                console.log('1. Auth state:', auth.currentUser);
                console.log('2. Current user:', currentUser);
                
                if (!currentUser) {
                    throw new Error('Not authenticated');
                }
                
                // Test 2: Try to read clients collection (should work)
                console.log('3. Testing clients collection access...');
                const clientsQuery = query(collection(db, "clients"), where("uid", "==", currentUser.uid));
                const clientsSnapshot = await getDocs(clientsQuery);
                console.log('4. Clients query successful, size:', clientsSnapshot.size);
                
                // Test 3: Try to read all nutrition plans (admin-level access)
                console.log('5. Testing nutrition plans collection access (all documents)...');
                const allNutritionQuery = query(collection(db, "nutritionPlans"));
                const allNutritionSnapshot = await getDocs(allNutritionQuery);
                console.log('6. All nutrition plans query successful, size:', allNutritionSnapshot.size);
                
                // Test 4: Try filtered nutrition plans query
                console.log('7. Testing filtered nutrition plans query...');
                const filteredQuery = query(collection(db, "nutritionPlans"), where("clientUid", "==", currentUser.uid));
                const filteredSnapshot = await getDocs(filteredQuery);
                console.log('8. Filtered nutrition plans query successful, size:', filteredSnapshot.size);
                
                console.log('✅ All Firebase tests passed!');
                showMessage('Firebase connection test successful!', 'success');
                return true;
                
            } catch (error) {
                console.error('❌ Firebase test failed:', error);
                showMessage(`Firebase test failed: ${error.message}`, 'error');
                return false;
            }
        }

        // Comprehensive Food Database with accurate nutrition per 100g and realistic serving units
        const foodDatabase = [
            // ===== PROTEIN SOURCES =====
            // Poultry
            { name: "Chicken Breast", calories: 165, protein: 31, carbs: 0, fat: 3.6, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Chicken Thigh", calories: 209, protein: 26, carbs: 0, fat: 11, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Turkey Breast", calories: 135, protein: 30, carbs: 0, fat: 0.7, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Duck Breast", calories: 132, protein: 23, carbs: 0, fat: 4.2, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            
            // Fish & Seafood
            { name: "Salmon", calories: 208, protein: 25, carbs: 0, fat: 12, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Tuna", calories: 144, protein: 30, carbs: 0, fat: 1, category: "protein", defaultServingAmount: 120, defaultServingUnit: "grams" },
            { name: "Cod", calories: 82, protein: 18, carbs: 0, fat: 0.7, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Mackerel", calories: 205, protein: 19, carbs: 0, fat: 14, category: "protein", defaultServingAmount: 120, defaultServingUnit: "grams" },
            { name: "Sardines", calories: 208, protein: 25, carbs: 0, fat: 11, category: "protein", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Shrimp", calories: 99, protein: 18, carbs: 0.9, fat: 1.7, category: "protein", defaultServingAmount: 120, defaultServingUnit: "grams" },
            { name: "Crab", calories: 97, protein: 19, carbs: 0, fat: 1.8, category: "protein", defaultServingAmount: 100, defaultServingUnit: "grams" },
            
            // Red Meat
            { name: "Lean Beef", calories: 186, protein: 26, carbs: 0, fat: 8, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Ground Beef (93% lean)", calories: 176, protein: 25, carbs: 0, fat: 8, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Pork Tenderloin", calories: 143, protein: 26, carbs: 0, fat: 3.5, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Lamb", calories: 250, protein: 25, carbs: 0, fat: 16, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            
            // Plant-Based Proteins
            { name: "Tofu", calories: 76, protein: 8, carbs: 1.9, fat: 4.8, category: "protein", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Tempeh", calories: 192, protein: 19, carbs: 9, fat: 11, category: "protein", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Seitan", calories: 125, protein: 25, carbs: 4, fat: 0.5, category: "protein", defaultServingAmount: 100, defaultServingUnit: "grams" },
            
            // Eggs & Dairy Proteins
            { name: "Eggs", calories: 140, protein: 12, carbs: 1, fat: 10, category: "protein", defaultServingAmount: 2, defaultServingUnit: "pieces" },
            { name: "Egg Whites", calories: 52, protein: 11, carbs: 0.7, fat: 0.2, category: "protein", defaultServingAmount: 4, defaultServingUnit: "pieces" },
            { name: "Greek Yogurt", calories: 59, protein: 10, carbs: 3.6, fat: 0.4, category: "protein", defaultServingAmount: 200, defaultServingUnit: "grams" },
            { name: "Cottage Cheese", calories: 98, protein: 11, carbs: 3.4, fat: 4.3, category: "protein", defaultServingAmount: 200, defaultServingUnit: "grams" },
            
            // ===== VEGETABLES =====
            // Leafy Greens
            { name: "Spinach", calories: 23, protein: 2.9, carbs: 3.6, fat: 0.4, category: "vegetables", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Kale", calories: 49, protein: 4.3, carbs: 9, fat: 0.9, category: "vegetables", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Arugula", calories: 25, protein: 2.6, carbs: 3.7, fat: 0.7, category: "vegetables", defaultServingAmount: 80, defaultServingUnit: "grams" },
            { name: "Lettuce", calories: 15, protein: 1.4, carbs: 2.9, fat: 0.2, category: "vegetables", defaultServingAmount: 100, defaultServingUnit: "grams" },
            
            // Cruciferous Vegetables
            { name: "Broccoli", calories: 34, protein: 2.8, carbs: 7, fat: 0.4, category: "vegetables", defaultServingAmount: 200, defaultServingUnit: "grams" },
            { name: "Cauliflower", calories: 25, protein: 1.9, carbs: 5, fat: 0.3, category: "vegetables", defaultServingAmount: 200, defaultServingUnit: "grams" },
            { name: "Brussels Sprouts", calories: 43, protein: 3.4, carbs: 9, fat: 0.3, category: "vegetables", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Cabbage", calories: 25, protein: 1.3, carbs: 6, fat: 0.1, category: "vegetables", defaultServingAmount: 150, defaultServingUnit: "grams" },
            
            // Root Vegetables
            { name: "Carrots", calories: 41, protein: 0.9, carbs: 10, fat: 0.2, category: "vegetables", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Beets", calories: 43, protein: 1.6, carbs: 10, fat: 0.2, category: "vegetables", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Sweet Potato", calories: 86, protein: 1.6, carbs: 20, fat: 0.1, category: "vegetables", defaultServingAmount: 200, defaultServingUnit: "grams" },
            { name: "Turnips", calories: 28, protein: 0.9, carbs: 6, fat: 0.1, category: "vegetables", defaultServingAmount: 150, defaultServingUnit: "grams" },
            
            // Other Vegetables
            { name: "Bell Peppers", calories: 31, protein: 1, carbs: 7, fat: 0.3, category: "vegetables", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Zucchini", calories: 17, protein: 1.2, carbs: 3.1, fat: 0.3, category: "vegetables", defaultServingAmount: 200, defaultServingUnit: "grams" },
            { name: "Asparagus", calories: 20, protein: 2.2, carbs: 3.9, fat: 0.1, category: "vegetables", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Green Beans", calories: 31, protein: 1.8, carbs: 7, fat: 0.2, category: "vegetables", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Cucumber", calories: 16, protein: 0.7, carbs: 4, fat: 0.1, category: "vegetables", defaultServingAmount: 200, defaultServingUnit: "grams" },
            { name: "Tomatoes", calories: 18, protein: 0.9, carbs: 3.9, fat: 0.2, category: "vegetables", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Mushrooms", calories: 22, protein: 3.1, carbs: 3.3, fat: 0.3, category: "vegetables", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Onions", calories: 40, protein: 1.1, carbs: 9, fat: 0.1, category: "vegetables", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Garlic", calories: 42, protein: 1.9, carbs: 9.3, fat: 0.1, category: "vegetables", defaultServingAmount: 10, defaultServingUnit: "grams" },
            
            // ===== FRUITS =====
            // Common Fruits
            { name: "Apple", calories: 52, protein: 0.3, carbs: 14, fat: 0.2, category: "fruits", defaultServingAmount: 1, defaultServingUnit: "pieces" },
            { name: "Banana", calories: 89, protein: 1.1, carbs: 23, fat: 0.3, category: "fruits", defaultServingAmount: 1, defaultServingUnit: "pieces" },
            { name: "Orange", calories: 47, protein: 0.9, carbs: 12, fat: 0.1, category: "fruits", defaultServingAmount: 1, defaultServingUnit: "pieces" },
            { name: "Grapes", calories: 62, protein: 0.6, carbs: 16, fat: 0.2, category: "fruits", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Pineapple", calories: 50, protein: 0.5, carbs: 13, fat: 0.1, category: "fruits", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Mango", calories: 60, protein: 0.8, carbs: 15, fat: 0.4, category: "fruits", defaultServingAmount: 150, defaultServingUnit: "grams" },
            
            // Berries
            { name: "Strawberries", calories: 32, protein: 0.7, carbs: 7.7, fat: 0.3, category: "fruits", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Blueberries", calories: 57, protein: 0.7, carbs: 14, fat: 0.3, category: "fruits", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Raspberries", calories: 52, protein: 1.2, carbs: 12, fat: 0.7, category: "fruits", defaultServingAmount: 120, defaultServingUnit: "grams" },
            { name: "Blackberries", calories: 43, protein: 1.4, carbs: 10, fat: 0.5, category: "fruits", defaultServingAmount: 120, defaultServingUnit: "grams" },
            
            // Other Fruits
            { name: "Avocado", calories: 160, protein: 2, carbs: 9, fat: 15, category: "fruits", defaultServingAmount: 1, defaultServingUnit: "pieces" },
            { name: "Kiwi", calories: 61, protein: 1.1, carbs: 15, fat: 0.5, category: "fruits", defaultServingAmount: 2, defaultServingUnit: "pieces" },
            { name: "Pear", calories: 57, protein: 0.4, carbs: 15, fat: 0.1, category: "fruits", defaultServingAmount: 1, defaultServingUnit: "pieces" },
            { name: "Peach", calories: 39, protein: 0.9, carbs: 10, fat: 0.2, category: "fruits", defaultServingAmount: 1, defaultServingUnit: "pieces" },
            { name: "Watermelon", calories: 30, protein: 0.6, carbs: 8, fat: 0.2, category: "fruits", defaultServingAmount: 200, defaultServingUnit: "grams" },
            
            // ===== GRAINS & STARCHES =====
            // Rice & Grains
            { name: "Brown Rice", calories: 111, protein: 2.6, carbs: 23, fat: 0.9, category: "grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            { name: "White Rice", calories: 130, protein: 2.7, carbs: 28, fat: 0.3, category: "grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            { name: "Quinoa", calories: 120, protein: 4.4, carbs: 22, fat: 1.9, category: "grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            { name: "Wild Rice", calories: 101, protein: 4, carbs: 21, fat: 0.3, category: "grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            { name: "Barley", calories: 123, protein: 2.3, carbs: 28, fat: 0.4, category: "grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            { name: "Bulgur", calories: 83, protein: 3, carbs: 19, fat: 0.2, category: "grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            
            // Oats & Cereals
            { name: "Oatmeal (cooked)", calories: 68, protein: 2.4, carbs: 12, fat: 1.4, category: "grains", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Steel Cut Oats (cooked)", calories: 62, protein: 2.5, carbs: 11, fat: 1.2, category: "grains", defaultServingAmount: 150, defaultServingUnit: "grams" },
            
            // Pasta & Noodles
            { name: "Whole Wheat Pasta", calories: 124, protein: 5, carbs: 25, fat: 1, category: "grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            { name: "Regular Pasta", calories: 131, protein: 5, carbs: 25, fat: 1.1, category: "grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            
            // Bread
            { name: "Whole Wheat Bread", calories: 160, protein: 8, carbs: 28, fat: 2.5, category: "grains", defaultServingAmount: 2, defaultServingUnit: "pieces" },
            { name: "Sourdough Bread", calories: 220, protein: 9, carbs: 43, fat: 1.2, category: "grains", defaultServingAmount: 2, defaultServingUnit: "pieces" },
            { name: "Ezekiel Bread", calories: 80, protein: 4, carbs: 15, fat: 0.5, category: "grains", defaultServingAmount: 2, defaultServingUnit: "pieces" },
            
            // ===== LEGUMES =====
            { name: "Lentils", calories: 116, protein: 9, carbs: 20, fat: 0.4, category: "legumes", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Chickpeas", calories: 164, protein: 8, carbs: 27, fat: 2.6, category: "legumes", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Black Beans", calories: 132, protein: 9, carbs: 24, fat: 0.5, category: "legumes", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Kidney Beans", calories: 127, protein: 9, carbs: 23, fat: 0.5, category: "legumes", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Pinto Beans", calories: 143, protein: 9, carbs: 26, fat: 0.7, category: "legumes", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Navy Beans", calories: 140, protein: 8, carbs: 26, fat: 0.6, category: "legumes", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Green Peas", calories: 81, protein: 5, carbs: 14, fat: 0.4, category: "legumes", defaultServingAmount: 150, defaultServingUnit: "grams" },
            
            // ===== DAIRY =====
            { name: "Milk (2%)", calories: 50, protein: 3.3, carbs: 4.8, fat: 2, category: "dairy", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Whole Milk", calories: 61, protein: 3.3, carbs: 4.8, fat: 3.3, category: "dairy", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Skim Milk", calories: 34, protein: 3.4, carbs: 5, fat: 0.2, category: "dairy", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Almond Milk", calories: 17, protein: 0.6, carbs: 1.5, fat: 1.4, category: "dairy", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Oat Milk", calories: 47, protein: 1, carbs: 8, fat: 1.5, category: "dairy", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Soy Milk", calories: 33, protein: 2.9, carbs: 1.2, fat: 1.8, category: "dairy", defaultServingAmount: 1, defaultServingUnit: "cups" },
            
            // Cheese
            { name: "Cheddar Cheese", calories: 121, protein: 7.5, carbs: 0.4, fat: 10, category: "dairy", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Mozzarella", calories: 84, protein: 8.4, carbs: 0.7, fat: 5.1, category: "dairy", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Parmesan", calories: 86, protein: 7.6, carbs: 0.8, fat: 5.8, category: "dairy", defaultServingAmount: 20, defaultServingUnit: "grams" },
            { name: "Feta Cheese", calories: 79, protein: 4.2, carbs: 1.2, fat: 6.3, category: "dairy", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Swiss Cheese", calories: 118, protein: 8.1, carbs: 1.5, fat: 9.3, category: "dairy", defaultServingAmount: 30, defaultServingUnit: "grams" },
            
            // ===== NUTS & SEEDS =====
            // Nuts
            { name: "Almonds", calories: 174, protein: 6.4, carbs: 6.6, fat: 15, category: "nuts", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Walnuts", calories: 196, protein: 4.6, carbs: 4.1, fat: 19.5, category: "nuts", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Cashews", calories: 166, protein: 5.4, carbs: 9, fat: 13.2, category: "nuts", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Pistachios", calories: 168, protein: 6, carbs: 8.4, fat: 13.5, category: "nuts", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Pecans", calories: 207, protein: 2.7, carbs: 4.2, fat: 21.6, category: "nuts", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Brazil Nuts", calories: 132, protein: 2.8, carbs: 2.4, fat: 13.4, category: "nuts", defaultServingAmount: 20, defaultServingUnit: "grams" },
            { name: "Hazelnuts", calories: 188, protein: 4.5, carbs: 5.1, fat: 18.3, category: "nuts", defaultServingAmount: 30, defaultServingUnit: "grams" },
            
            // Seeds
            { name: "Chia Seeds", calories: 73, protein: 2.6, carbs: 6.3, fat: 4.7, category: "nuts", defaultServingAmount: 15, defaultServingUnit: "grams" },
            { name: "Flax Seeds", calories: 80, protein: 2.7, carbs: 4.4, fat: 6.3, category: "nuts", defaultServingAmount: 15, defaultServingUnit: "grams" },
            { name: "Pumpkin Seeds", calories: 168, protein: 5.7, carbs: 16.2, fat: 14.7, category: "nuts", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Sunflower Seeds", calories: 175, protein: 6.3, carbs: 6, fat: 15.3, category: "nuts", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Hemp Seeds", calories: 111, protein: 6.2, carbs: 1.6, fat: 9.8, category: "nuts", defaultServingAmount: 20, defaultServingUnit: "grams" },
            { name: "Sesame Seeds", calories: 86, protein: 2.7, carbs: 3.5, fat: 7.5, category: "nuts", defaultServingAmount: 15, defaultServingUnit: "grams" },
            
            // ===== HEALTHY FATS & OILS =====
            { name: "Olive Oil", calories: 119, protein: 0, carbs: 0, fat: 13.5, category: "fats", defaultServingAmount: 1, defaultServingUnit: "tablespoons" },
            { name: "Coconut Oil", calories: 117, protein: 0, carbs: 0, fat: 13.5, category: "fats", defaultServingAmount: 1, defaultServingUnit: "tablespoons" },
            { name: "Avocado Oil", calories: 124, protein: 0, carbs: 0, fat: 14, category: "fats", defaultServingAmount: 1, defaultServingUnit: "tablespoons" },
            { name: "Peanut Butter", calories: 190, protein: 8, carbs: 8, fat: 16, category: "fats", defaultServingAmount: 2, defaultServingUnit: "tablespoons" },
            { name: "Almond Butter", calories: 196, protein: 7, carbs: 7, fat: 18, category: "fats", defaultServingAmount: 2, defaultServingUnit: "tablespoons" },
            { name: "Tahini", calories: 119, protein: 3.6, carbs: 4.6, fat: 10.5, category: "fats", defaultServingAmount: 2, defaultServingUnit: "tablespoons" },
            
            // ===== SNACKS & TREATS =====
            { name: "Dark Chocolate (70%)", calories: 164, protein: 2.3, carbs: 13.5, fat: 9.3, category: "snacks", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Popcorn (Air-popped)", calories: 115, protein: 3.8, carbs: 23, fat: 1.3, category: "snacks", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Rice Cakes", calories: 35, protein: 0.7, carbs: 7.3, fat: 0.4, category: "snacks", defaultServingAmount: 2, defaultServingUnit: "pieces" },
            
            // ===== HERBS & SPICES =====
            { name: "Ginger", calories: 80, protein: 1.8, carbs: 18, fat: 0.8, category: "herbs", defaultServingAmount: 5, defaultServingUnit: "grams" },
            { name: "Turmeric", calories: 7, protein: 0.16, carbs: 1.3, fat: 0.2, category: "herbs", defaultServingAmount: 2, defaultServingUnit: "grams" },
            { name: "Basil", calories: 22, protein: 3.2, carbs: 2.6, fat: 0.6, category: "herbs", defaultServingAmount: 5, defaultServingUnit: "grams" },
            { name: "Parsley", calories: 36, protein: 3, carbs: 6, fat: 0.8, category: "herbs", defaultServingAmount: 10, defaultServingUnit: "grams" },
            
            // ===== ARABIC & MIDDLE EASTERN FOODS =====
            // Traditional Dishes
            { name: "Hummus", calories: 166, protein: 8, carbs: 14, fat: 10, category: "arabic", defaultServingAmount: 100, defaultServingUnit: "grams", 
              ingredients: "Chickpeas (cooked) 60g, Tahini 15g, Lemon juice 10g, Garlic 3g, Olive oil 8g, Salt 1g, Cumin 0.5g, Water 2.5g" },
            { name: "Falafel", calories: 333, protein: 13, carbs: 32, fat: 18, category: "arabic", defaultServingAmount: 4, defaultServingUnit: "pieces",
              ingredients: "Chickpeas (dried, soaked) 50g, Parsley 10g, Onion 15g, Garlic 5g, Cumin 2g, Coriander 2g, Salt 2g, Baking powder 1g, Oil for frying 13g" },
            { name: "Tabbouleh", calories: 36, protein: 1.5, carbs: 6, fat: 1.2, category: "arabic", defaultServingAmount: 150, defaultServingUnit: "grams",
              ingredients: "Parsley 80g, Tomatoes 40g, Bulgur wheat 15g, Mint 10g, Lemon juice 10g, Olive oil 8g, Salt 2g, Onion 5g" },
            { name: "Fattoush", calories: 79, protein: 2.8, carbs: 12, fat: 3, category: "arabic", defaultServingAmount: 200, defaultServingUnit: "grams",
              ingredients: "Mixed lettuce 60g, Tomatoes 50g, Cucumber 40g, Pita bread (toasted) 20g, Sumac 3g, Lemon juice 15g, Olive oil 10g, Mint 2g" },
            { name: "Baba Ganoush", calories: 112, protein: 2.8, carbs: 9, fat: 8, category: "arabic", defaultServingAmount: 100, defaultServingUnit: "grams",
              ingredients: "Eggplant (roasted) 70g, Tahini 12g, Lemon juice 8g, Garlic 4g, Olive oil 5g, Salt 1g" },
            { name: "Shawarma (Chicken)", calories: 250, protein: 27, carbs: 5, fat: 14, category: "arabic", defaultServingAmount: 150, defaultServingUnit: "grams",
              ingredients: "Chicken thigh 120g, Onion 15g, Yogurt 8g, Olive oil 5g, Garlic 2g, Baharat spice 2g, Salt 1g, Lemon juice 2g" },
            { name: "Shawarma (Lamb)", calories: 295, protein: 23, carbs: 4, fat: 21, category: "arabic", defaultServingAmount: 150, defaultServingUnit: "grams",
              ingredients: "Lamb shoulder 120g, Onion 15g, Yogurt 8g, Olive oil 5g, Garlic 2g, Baharat spice 2g, Salt 1g, Sumac 1g" },
            { name: "Chicken Kebab", calories: 200, protein: 26, carbs: 2, fat: 9, category: "arabic", defaultServingAmount: 150, defaultServingUnit: "grams",
              ingredients: "Chicken breast 130g, Onion 10g, Garlic 3g, Olive oil 4g, Yogurt 5g, Paprika 1g, Cumin 1g, Salt 1g" },
            { name: "Lamb Kebab", calories: 280, protein: 24, carbs: 1, fat: 20, category: "arabic", defaultServingAmount: 150, defaultServingUnit: "grams",
              ingredients: "Ground lamb 130g, Onion 10g, Parsley 5g, Garlic 2g, Baharat spice 2g, Salt 1g" },
            { name: "Manakish (Za'atar)", calories: 285, protein: 8, carbs: 45, fat: 9, category: "arabic", defaultServingAmount: 1, defaultServingUnit: "pieces",
              ingredients: "Pita dough 80g, Za'atar blend 8g, Olive oil 12g" },
            { name: "Labneh", calories: 80, protein: 6, carbs: 4, fat: 5, category: "arabic", defaultServingAmount: 100, defaultServingUnit: "grams",
              ingredients: "Greek yogurt 120g (strained overnight with salt 2g)" },
            { name: "Halloumi Cheese", calories: 257, protein: 19.2, carbs: 1.6, fat: 19.2, category: "arabic", defaultServingAmount: 80, defaultServingUnit: "grams",
              ingredients: "Traditional cheese (no recipe - commercial product)" },
            { name: "Makloubeh", calories: 180, protein: 8, carbs: 25, fat: 6, category: "arabic", defaultServingAmount: 200, defaultServingUnit: "grams",
              ingredients: "Basmati rice 60g, Chicken pieces 40g, Eggplant 30g, Cauliflower 25g, Onion 20g, Olive oil 8g, Baharat spice 3g, Salt 2g, Almonds 5g, Pine nuts 3g, Stock 4g" },
            { name: "Mjaddara", calories: 140, protein: 6, carbs: 26, fat: 2, category: "arabic", defaultServingAmount: 200, defaultServingUnit: "grams",
              ingredients: "Brown lentils 50g, Rice 40g, Onion (caramelized) 30g, Olive oil 6g, Cumin 2g, Salt 2g, Bay leaves 1g, Water/stock 69g" },
            { name: "Mahshi Waraq Enab", calories: 120, protein: 4, carbs: 18, fat: 4, category: "arabic", defaultServingAmount: 200, defaultServingUnit: "grams",
              ingredients: "Grape leaves 30g, Rice 40g, Ground lamb 20g, Onion 15g, Tomato 20g, Parsley 10g, Mint 5g, Olive oil 8g, Lemon juice 10g, Spices 2g" },
            
            // ===== EGYPTIAN FOODS =====
            // Traditional Egyptian Dishes
            { name: "Ful Medames", calories: 187, protein: 12, carbs: 33, fat: 1, category: "egyptian", defaultServingAmount: 200, defaultServingUnit: "grams",
              ingredients: "Fava beans (cooked) 150g, Tomato 20g, Onion 15g, Garlic 5g, Lemon juice 8g, Olive oil 4g, Cumin 2g, Salt 2g, Parsley 4g" },
            { name: "Ta'meya (Egyptian Falafel)", calories: 310, protein: 12, carbs: 35, fat: 15, category: "egyptian", defaultServingAmount: 4, defaultServingUnit: "pieces",
              ingredients: "Fava beans (dried, soaked) 60g, Parsley 15g, Cilantro 10g, Onion 20g, Garlic 8g, Cumin 3g, Coriander seeds 2g, Salt 3g, Sesame seeds 5g, Oil for frying 15g" },
            { name: "Koshari", calories: 165, protein: 6, carbs: 30, fat: 3, category: "egyptian", defaultServingAmount: 250, defaultServingUnit: "grams",
              ingredients: "Rice 60g, Brown lentils 40g, Macaroni 30g, Chickpeas 25g, Onion (fried) 20g, Tomato sauce 50g, Garlic 5g, Cumin 2g, Vinegar 10g, Oil 8g" },
            { name: "Molokhia (Jute Soup)", calories: 45, protein: 4, carbs: 8, fat: 0.5, category: "egyptian", defaultServingAmount: 250, defaultServingUnit: "grams",
              ingredients: "Molokhia leaves (chopped) 100g, Chicken stock 120g, Garlic 8g, Coriander (ground) 2g, Onion 15g, Lemon juice 5g" },
            { name: "Mahshi Waraq Enab (Stuffed Grape Leaves)", calories: 98, protein: 2.5, carbs: 18, fat: 2, category: "egyptian", defaultServingAmount: 6, defaultServingUnit: "pieces",
              ingredients: "Grape leaves 30g, Rice 40g, Tomato (diced) 15g, Onion 10g, Parsley 8g, Mint 3g, Lemon juice 8g, Olive oil 6g, Salt 2g, Pine nuts 3g" },
            { name: "Mahshi Kousa (Stuffed Zucchini)", calories: 110, protein: 4, carbs: 20, fat: 2.5, category: "egyptian", defaultServingAmount: 3, defaultServingUnit: "pieces",
              ingredients: "Small zucchini (hollowed) 120g, Rice 35g, Ground meat 20g, Tomato 10g, Onion 8g, Parsley 5g, Dill 3g, Olive oil 5g, Salt 2g, Spices 2g" },
            { name: "Bamia (Egyptian Okra Stew)", calories: 85, protein: 3, carbs: 16, fat: 2, category: "egyptian", defaultServingAmount: 200, defaultServingUnit: "grams",
              ingredients: "Okra 120g, Tomato sauce 40g, Onion 20g, Garlic 5g, Beef/lamb pieces 30g, Olive oil 6g, Coriander 2g, Salt 2g, Water 25g" },
            { name: "Roz bel Laban (Rice Pudding)", calories: 130, protein: 4, carbs: 24, fat: 2.5, category: "egyptian", defaultServingAmount: 150, defaultServingUnit: "grams",
              ingredients: "Rice (short grain) 25g, Whole milk 100g, Sugar 15g, Vanilla 1g, Cornstarch 3g, Raisins 5g, Coconut flakes 1g" },
            { name: "Egyptian Baladi Bread", calories: 265, protein: 8, carbs: 55, fat: 1.5, category: "egyptian", defaultServingAmount: 1, defaultServingUnit: "pieces",
              ingredients: "Whole wheat flour 80g, Water 35g, Salt 2g, Yeast 1g, Bran 2g" },
            { name: "Gebna Beida (Egyptian White Cheese)", calories: 230, protein: 18, carbs: 3, fat: 16, category: "egyptian", defaultServingAmount: 50, defaultServingUnit: "grams",
              ingredients: "Traditional cheese (no recipe - commercial/artisanal product)" },
            { name: "Egyptian Lentil Soup", calories: 95, protein: 6, carbs: 17, fat: 1, category: "egyptian", defaultServingAmount: 250, defaultServingUnit: "grams",
              ingredients: "Red lentils 60g, Onion 25g, Carrot 20g, Tomato 20g, Garlic 5g, Vegetable stock 100g, Cumin 2g, Turmeric 1g, Olive oil 3g, Salt 2g, Lemon juice 5g" },
            { name: "Basbousa", calories: 320, protein: 5, carbs: 45, fat: 14, category: "egyptian", defaultServingAmount: 80, defaultServingUnit: "grams",
              ingredients: "Semolina 35g, Sugar 20g, Coconut 10g, Yogurt 15g, Butter 8g, Almonds 5g, Sugar syrup 25g, Baking powder 1g, Vanilla 1g" },
            { name: "Konafa", calories: 395, protein: 7, carbs: 42, fat: 22, category: "egyptian", defaultServingAmount: 100, defaultServingUnit: "grams",
              ingredients: "Konafa dough 40g, Ricotta/cream cheese 25g, Sugar 15g, Butter 12g, Pistachios 8g, Sugar syrup 20g, Rose water 2g" },
            
            // ===== ARABIC INGREDIENTS & SPICES =====
            // Traditional Spices & Seasonings
            { name: "Za'atar", calories: 14, protein: 0.25, carbs: 2.4, fat: 0.4, category: "arabic-spices", defaultServingAmount: 5, defaultServingUnit: "grams" },
            { name: "Sumac", calories: 10, protein: 0.09, carbs: 2.1, fat: 0.09, category: "arabic-spices", defaultServingAmount: 3, defaultServingUnit: "grams" },
            { name: "Baharat (7 Spice)", calories: 9, protein: 0.24, carbs: 1.7, fat: 0.15, category: "arabic-spices", defaultServingAmount: 3, defaultServingUnit: "grams" },
            { name: "Cardamom", calories: 6, protein: 0.22, carbs: 1.4, fat: 0.14, category: "arabic-spices", defaultServingAmount: 2, defaultServingUnit: "grams" },
            { name: "Dukkah", calories: 52, protein: 1.8, carbs: 2.2, fat: 4.2, category: "arabic-spices", defaultServingAmount: 10, defaultServingUnit: "grams" },
            { name: "Rose Water", calories: 1, protein: 0, carbs: 0, fat: 0, category: "arabic-spices", defaultServingAmount: 5, defaultServingUnit: "ml" },
            { name: "Orange Blossom Water", calories: 1, protein: 0, carbs: 0, fat: 0, category: "arabic-spices", defaultServingAmount: 5, defaultServingUnit: "ml" },
            
            // Traditional Grains & Legumes
            { name: "Freekeh", calories: 141, protein: 6, carbs: 28, fat: 1, category: "arabic-grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            { name: "Egyptian Rice (cooked)", calories: 130, protein: 2.7, carbs: 28, fat: 0.3, category: "arabic-grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            { name: "Fava Beans (Fresh)", calories: 88, protein: 8, carbs: 17, fat: 0.8, category: "arabic-grains", defaultServingAmount: 150, defaultServingUnit: "grams" },
            { name: "Black Beluga Lentils (cooked)", calories: 115, protein: 9, carbs: 20, fat: 0.4, category: "arabic-grains", defaultServingAmount: 80, defaultServingUnit: "grams" },
            
            // Traditional Fruits & Sweets
            { name: "Medjool Dates", calories: 199, protein: 1.4, carbs: 54, fat: 0.1, category: "arabic-fruits", defaultServingAmount: 3, defaultServingUnit: "pieces" },
            { name: "Fresh Figs", calories: 74, protein: 0.8, carbs: 19, fat: 0.3, category: "arabic-fruits", defaultServingAmount: 3, defaultServingUnit: "pieces" },
            { name: "Pomegranate Seeds", calories: 83, protein: 1.7, carbs: 19, fat: 1.2, category: "arabic-fruits", defaultServingAmount: 100, defaultServingUnit: "grams" },
            { name: "Turkish Delight", calories: 320, protein: 0, carbs: 80, fat: 0, category: "arabic-fruits", defaultServingAmount: 30, defaultServingUnit: "grams" },
            { name: "Halva", calories: 141, protein: 3.9, carbs: 16.2, fat: 7.5, category: "arabic-fruits", defaultServingAmount: 30, defaultServingUnit: "grams" },
            
            // Traditional Dairy & Proteins
            { name: "Kashkaval Cheese", calories: 173, protein: 12.5, carbs: 1, fat: 13, category: "arabic-dairy", defaultServingAmount: 50, defaultServingUnit: "grams" },
            { name: "Jibneh Arabieh (Arabic Cheese)", calories: 140, protein: 10, carbs: 0.5, fat: 11, category: "arabic-dairy", defaultServingAmount: 50, defaultServingUnit: "grams" },
            { name: "Kefir", calories: 41, protein: 3.8, carbs: 4.5, fat: 1, category: "arabic-dairy", defaultServingAmount: 200, defaultServingUnit: "ml" },
            
            // ===== BEVERAGES (per 100ml for tea/coffee) =====
            { name: "Green Tea", calories: 1, protein: 0, carbs: 0, fat: 0, category: "beverages", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Black Coffee", calories: 2, protein: 0.3, carbs: 0, fat: 0, category: "beverages", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Coconut Water", calories: 19, protein: 0.7, carbs: 3.7, fat: 0.2, category: "beverages", defaultServingAmount: 1, defaultServingUnit: "cups" },
            
            // Traditional Arabic/Middle Eastern Beverages
            { name: "Arabic Coffee (Qahwa)", calories: 2, protein: 0.1, carbs: 0, fat: 0, category: "arabic-beverages", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Mint Tea (Atay)", calories: 2, protein: 0, carbs: 0.5, fat: 0, category: "arabic-beverages", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Tamarind Juice", calories: 42, protein: 0.3, carbs: 11, fat: 0.1, category: "arabic-beverages", defaultServingAmount: 200, defaultServingUnit: "ml" },
            { name: "Hibiscus Tea (Karkade)", calories: 5, protein: 0.1, carbs: 1.3, fat: 0, category: "arabic-beverages", defaultServingAmount: 1, defaultServingUnit: "cups" },
            { name: "Sahlab", calories: 95, protein: 3, carbs: 18, fat: 1.5, category: "arabic-beverages", defaultServingAmount: 200, defaultServingUnit: "ml" },
            { name: "Jallab", calories: 85, protein: 0.2, carbs: 22, fat: 0.1, category: "arabic-beverages", defaultServingAmount: 200, defaultServingUnit: "ml" }
        ];

        function showFoodReplacementModal(planId, mealType, itemIndex, currentFood, calories, protein, carbs, fat, day = 1) {
            console.log('=== SHOWING FOOD REPLACEMENT MODAL ===');
            console.log('showFoodReplacementModal called with:', {
                planId, mealType, itemIndex, currentFood, calories, protein, carbs, fat, day
            });
            
            // Validate input parameters
            if (!planId || !mealType || itemIndex === undefined || !currentFood) {
                console.error('❌ Invalid parameters for showFoodReplacementModal:', {
                    planId, mealType, itemIndex, currentFood
                });
                showMessage('Error: Invalid food replacement parameters. Please try again.', 'error');
                return;
            }
            
            // Create replacement context
            currentReplacementContext = {
                planId,
                mealType,
                itemIndex,
                currentFood,
                day: day || 1, // Default to day 1 for backwards compatibility
                originalNutrition: { calories, protein, carbs, fat }
            };
            
            // Make function globally accessible for debugging
            window.showFoodReplacementModal = showFoodReplacementModal;

            // Check if we have nutrition plans loaded
            if (!nutritionPlans || nutritionPlans.length === 0) {
                console.error('No nutrition plans loaded for replacement');
                showMessage('Please wait for nutrition plans to load before replacing foods.', 'error');
                return;
            }
            
            // Find similar foods based on nutritional content with default settings
            const similarFoods = findSimilarFoods({ calories, protein, carbs, fat }, 'balanced', true);
            
            if (!similarFoods || similarFoods.length === 0) {
                console.error('No similar foods found');
                showMessage('No similar foods found in database.', 'error');
                return;
            }
            
            console.log('Found', similarFoods.length, 'similar foods');
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'foodReplacementModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;

            modal.innerHTML = `
                <div class="food-replacement-modal" style="background: white; border-radius: 1rem; padding: 2rem; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb;">
                        <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem;">Replace "${currentFood}"</h3>
                        <button onclick="closeFoodReplacementModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #374151;">Current Food:</h4>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
                            <div><strong>${calories}</strong><br><small>Calories</small></div>
                            <div><strong>${protein}g</strong><br><small>Protein</small></div>
                            <div><strong>${carbs}g</strong><br><small>Carbs</small></div>
                            <div><strong>${fat}g</strong><br><small>Fat</small></div>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <input type="text" id="foodSearchInput" placeholder="Search for foods..." style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem;">
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="margin-right: 1rem;">Filter by category:</label>
                        <select id="categoryFilter" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem;">
                            <option value="">All Categories</option>
                            <option value="protein">🥩 Protein Sources</option>
                            <option value="vegetables">🥬 Vegetables</option>
                            <option value="fruits">🍎 Fruits</option>
                            <option value="grains">🌾 Grains & Starches</option>
                            <option value="legumes">🫘 Legumes</option>
                            <option value="dairy">🥛 Dairy & Alternatives</option>
                            <option value="nuts">🥜 Nuts & Seeds</option>
                            <option value="fats">🫒 Healthy Fats & Oils</option>
                            <option value="snacks">🍿 Snacks & Treats</option>
                            <option value="herbs">🌿 Herbs & Spices</option>
                            <option value="beverages">☕ Beverages</option>
                            <option value="arabic">🥙 Arabic & Middle Eastern</option>
                            <option value="egyptian">🏺 Egyptian Traditional</option>
                            <option value="arabic-spices">🌶️ Arabic Spices & Seasonings</option>
                            <option value="arabic-grains">🌾 Arabic Grains & Legumes</option>
                            <option value="arabic-fruits">🍯 Arabic Fruits & Sweets</option>
                            <option value="arabic-dairy">🧀 Arabic Dairy & Cheese</option>
                            <option value="arabic-beverages">🍵 Arabic Beverages</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #374151;">Find Close Replacements:</h4>
                        
                        <div class="food-replacement-filters" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Similarity Level:</label>
                                <select id="similarityLevel" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem;">
                                    <option value="80">Very Close (80%+)</option>
                                    <option value="60" selected>Close (60%+)</option>
                                    <option value="40">Somewhat Similar (40%+)</option>
                                    <option value="0">All Foods</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Priority:</label>
                                <select id="priorityType" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem;">
                                    <option value="balanced">Balanced Match</option>
                                    <option value="protein">Protein First</option>
                                    <option value="calories">Calories First</option>
                                    <option value="lowcarb">Low Carb Focus</option>
                                    <option value="lowfat">Low Fat Focus</option>
                                </select>
                            </div>
                        </div>

                        <div class="food-replacement-checkboxes" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">
                                    <input type="checkbox" id="adjustServing" style="margin-right: 0.5rem;" checked>
                                    Auto-adjust serving size for closer match
                                </label>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">
                                    <input type="checkbox" id="showOnlyCloser" style="margin-right: 0.5rem;">
                                    Show only nutritionally closer options
                                </label>
                            </div>
                        </div>
                    </div>

                    <h4 style="margin: 0 0 1rem 0; color: #374151;">Similar Foods (realistic servings):</h4>
                    <div id="similarFoodsList" style="max-height: 400px; overflow-y: auto;">
                        ${renderSimilarFoods(similarFoods)}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Add event listeners for filter controls
            document.getElementById('foodSearchInput').addEventListener('input', filterFoods);
            document.getElementById('categoryFilter').addEventListener('change', filterFoods);
            document.getElementById('similarityLevel').addEventListener('change', filterFoods);
            document.getElementById('priorityType').addEventListener('change', filterFoods);
            document.getElementById('adjustServing').addEventListener('change', filterFoods);
            document.getElementById('showOnlyCloser').addEventListener('change', filterFoods);
            
            // Add event listeners for food selection
            setupFoodSelectionListeners();
        }

        // Intelligent food replacement system that calculates equivalent serving sizes
        function findSimilarFoods(targetNutrition, priorityType = 'balanced', adjustServing = false) {
            console.log('🧠 Intelligent replacement analysis for:', targetNutrition);
            
            return foodDatabase.map(food => {
                // Calculate the optimal serving size to match target nutrition
                const equivalentServing = calculateEquivalentServing(targetNutrition, food, priorityType);
                
                // Create adjusted food with equivalent nutrition
                const adjustedFood = {
                    ...food,
                    calories: Math.round(food.calories * equivalentServing.multiplier),
                    protein: Math.round(food.protein * equivalentServing.multiplier * 10) / 10,
                    carbs: Math.round(food.carbs * equivalentServing.multiplier * 10) / 10,
                    fat: Math.round(food.fat * equivalentServing.multiplier * 10) / 10
                };
                
                // Calculate nutritional differences
                const caloriesDiff = Math.abs(adjustedFood.calories - targetNutrition.calories);
                const proteinDiff = Math.abs(adjustedFood.protein - targetNutrition.protein);
                const carbsDiff = Math.abs(adjustedFood.carbs - targetNutrition.carbs);
                const fatDiff = Math.abs(adjustedFood.fat - targetNutrition.fat);
                
                // Calculate weighted score based on priority type
                let score;
                switch (priorityType) {
                    case 'protein':
                        score = (caloriesDiff * 0.2) + (proteinDiff * 0.6) + (carbsDiff * 0.1) + (fatDiff * 0.1);
                        break;
                    case 'calories':
                        score = (caloriesDiff * 0.6) + (proteinDiff * 0.2) + (carbsDiff * 0.1) + (fatDiff * 0.1);
                        break;
                    case 'lowcarb':
                        score = (caloriesDiff * 0.3) + (proteinDiff * 0.3) + (carbsDiff * 0.3) + (fatDiff * 0.1);
                        // Bonus for foods with lower carbs than target
                        if (adjustedFood.carbs < targetNutrition.carbs) score *= 0.8;
                        break;
                    case 'lowfat':
                        score = (caloriesDiff * 0.3) + (proteinDiff * 0.3) + (carbsDiff * 0.1) + (fatDiff * 0.3);
                        // Bonus for foods with lower fat than target
                        if (adjustedFood.fat < targetNutrition.fat) score *= 0.8;
                        break;
                    default: // balanced
                        score = (caloriesDiff * 0.3) + (proteinDiff * 0.4) + (carbsDiff * 0.2) + (fatDiff * 0.1);
                }
                
                // Calculate similarity percentage (higher is better)
                const maxDiff = Math.max(targetNutrition.calories, targetNutrition.protein * 4, targetNutrition.carbs * 4, targetNutrition.fat * 9);
                const similarityPercentage = Math.max(0, 100 - (score / maxDiff) * 100);
                
                return {
                    ...adjustedFood,
                    originalFood: food,
                    similarityScore: score,
                    similarityPercentage: Math.round(similarityPercentage),
                    servingMultiplier: equivalentServing.multiplier,
                    equivalentAmount: equivalentServing.amount,
                    equivalentUnit: equivalentServing.unit,
                    equivalentDisplay: equivalentServing.display,
                    servingSize: Math.round(100 * equivalentServing.multiplier),
                    nutritionalEquivalence: equivalentServing.equivalence,
                    isIntelligentReplacement: true,
                    caloriesDiff,
                    proteinDiff,
                    carbsDiff,
                    fatDiff
                };
            }).sort((a, b) => a.similarityScore - b.similarityScore);
        }

        // Calculate the equivalent serving size needed to match target nutrition
        function calculateEquivalentServing(targetNutrition, food, priorityType = 'balanced') {
            // Calculate multipliers for each macro to match target
            const calorieMultiplier = food.calories > 0 ? targetNutrition.calories / food.calories : 1;
            const proteinMultiplier = food.protein > 0 ? targetNutrition.protein / food.protein : 1;
            const carbsMultiplier = food.carbs > 0 ? targetNutrition.carbs / food.carbs : 1;
            const fatMultiplier = food.fat > 0 ? targetNutrition.fat / food.fat : 1;
            
            // Choose the optimal multiplier based on priority
            let optimalMultiplier;
            switch (priorityType) {
                case 'protein':
                    optimalMultiplier = proteinMultiplier;
                    break;
                case 'calories':
                    optimalMultiplier = calorieMultiplier;
                    break;
                case 'lowcarb':
                    // Use calorie match but prefer lower carb options
                    optimalMultiplier = calorieMultiplier;
                    break;
                case 'lowfat':
                    // Use calorie match but prefer lower fat options
                    optimalMultiplier = calorieMultiplier;
                    break;
                case 'balanced':
                default:
                    // Use weighted average with emphasis on calories and protein
                    optimalMultiplier = (calorieMultiplier * 2 + proteinMultiplier * 1.5 + carbsMultiplier + fatMultiplier) / 5.5;
                    break;
            }
            
            // Keep multiplier within reasonable bounds (0.3x to 3x for realistic portions)
            optimalMultiplier = Math.max(0.3, Math.min(3, optimalMultiplier));
            
            // Calculate equivalent amount based on food's default serving
            const defaultAmount = food.defaultServingAmount || 100;
            const defaultUnit = food.defaultServingUnit || 'grams';
            
            let equivalentAmount, equivalentUnit, equivalentDisplay;
            
            if (defaultUnit === 'pieces') {
                // For piece-based foods, calculate equivalent pieces
                equivalentAmount = Math.round(defaultAmount * optimalMultiplier * 10) / 10;
                equivalentUnit = 'pieces';
                equivalentDisplay = `${equivalentAmount} ${equivalentAmount === 1 ? 'piece' : 'pieces'}`;
            } else if (defaultUnit === 'cups') {
                // For cup-based foods, calculate equivalent cups
                equivalentAmount = Math.round(defaultAmount * optimalMultiplier * 10) / 10;
                equivalentUnit = 'cups';
                equivalentDisplay = `${equivalentAmount} cup${equivalentAmount !== 1 ? 's' : ''}`;
            } else if (defaultUnit === 'tablespoons') {
                // For tablespoon-based foods, calculate equivalent tablespoons
                equivalentAmount = Math.round(defaultAmount * optimalMultiplier * 10) / 10;
                equivalentUnit = 'tablespoons';
                equivalentDisplay = `${equivalentAmount} tbsp`;
            } else {
                // For gram-based foods, calculate equivalent grams
                equivalentAmount = Math.round(defaultAmount * optimalMultiplier);
                equivalentUnit = 'grams';
                equivalentDisplay = `${equivalentAmount}g`;
            }
            
            // Calculate nutritional equivalence score
            const adjustedCalories = food.calories * optimalMultiplier;
            const adjustedProtein = food.protein * optimalMultiplier;
            const adjustedCarbs = food.carbs * optimalMultiplier;
            const adjustedFat = food.fat * optimalMultiplier;
            
            const calorieDiff = Math.abs(adjustedCalories - targetNutrition.calories);
            const proteinDiff = Math.abs(adjustedProtein - targetNutrition.protein);
            const carbsDiff = Math.abs(adjustedCarbs - targetNutrition.carbs);
            const fatDiff = Math.abs(adjustedFat - targetNutrition.fat);
            
            const totalDiff = calorieDiff + proteinDiff + carbsDiff + fatDiff;
            const totalTarget = targetNutrition.calories + targetNutrition.protein + targetNutrition.carbs + targetNutrition.fat;
            const equivalence = Math.max(0, Math.min(100, 100 - (totalDiff / totalTarget * 100)));
            
            return {
                multiplier: optimalMultiplier,
                amount: equivalentAmount,
                unit: equivalentUnit,
                display: equivalentDisplay,
                equivalence: Math.round(equivalence)
            };
        }

        function renderSimilarFoods(foods) {
            return foods.map(food => {
                // Use intelligent equivalent serving if available
                let servingText = '';
                if (food.isIntelligentReplacement && food.equivalentDisplay) {
                    servingText = ` (${food.equivalentDisplay} equivalent)`;
                } else {
                    // Fallback to original format
                    const defaultAmount = food.defaultServingAmount || 100;
                    const defaultUnit = food.defaultServingUnit || 'grams';
                    
                    if (defaultUnit === 'pieces') {
                        servingText = ` (${defaultAmount} pcs serving)`;
                    } else if (defaultUnit === 'cups') {
                        servingText = ` (${defaultAmount} cup${defaultAmount !== 1 ? 's' : ''} serving)`;
                    } else if (defaultUnit === 'tablespoons') {
                        servingText = ` (${defaultAmount} tbsp serving)`;
                    } else {
                        servingText = food.servingSize !== 100 ? ` (${food.servingSize}g serving)` : ` (${defaultAmount}g serving)`;
                    }
                }
                
                const similarityColor = food.similarityPercentage >= 80 ? '#059669' : 
                                       food.similarityPercentage >= 60 ? '#d97706' : '#6b7280';
                const borderColor = food.similarityPercentage >= 80 ? '#10b981' : 
                                   food.similarityPercentage >= 60 ? '#f59e0b' : '#e5e7eb';
                
                return `
                    <div class="food-selection-item" 
                         style="border: 2px solid ${borderColor}; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s ease; background: white;" 
                         onmouseover="this.style.backgroundColor='#f8fafc'; this.style.transform='translateY(-2px)'" 
                         onmouseout="this.style.backgroundColor='white'; this.style.transform='translateY(0)'"
                         data-food-name="${food.name}"
                         data-calories="${food.calories}"
                         data-protein="${food.protein}"
                         data-carbs="${food.carbs}"
                         data-fat="${food.fat}"
                         data-serving-size="${food.servingSize}"
                         data-default-serving-amount="${food.isIntelligentReplacement && food.equivalentAmount ? food.equivalentAmount : (food.originalFood ? food.originalFood.defaultServingAmount : food.defaultServingAmount)}"
                         data-default-serving-unit="${food.isIntelligentReplacement && food.equivalentUnit ? food.equivalentUnit : (food.originalFood ? food.originalFood.defaultServingUnit : food.defaultServingUnit)}"
                         data-is-intelligent-replacement="${food.isIntelligentReplacement || false}"
                         data-nutritional-equivalence="${food.nutritionalEquivalence || 0}"
                         title="Click to select this food">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                    <h5 style="margin: 0; color: #1f2937; font-size: 1rem;">${food.name}</h5>
                                    <span style="margin-left: 0.5rem; font-size: 0.75rem; color: #6b7280;">${servingText}</span>
                                    ${food.isIntelligentReplacement ? '<span style="margin-left: 0.5rem; background: #2563eb; color: white; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.6rem; font-weight: 600;">🧠 Smart Match</span>' : ''}
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; font-size: 0.875rem; margin-bottom: 0.5rem;">
                                    <div><strong>${food.calories}</strong> cal</div>
                                    <div><strong>${food.protein}g</strong> protein</div>
                                    <div><strong>${food.carbs}g</strong> carbs</div>
                                    <div><strong>${food.fat}g</strong> fat</div>
                                </div>
                                ${food.isIntelligentReplacement && food.equivalentDisplay ? `
                                <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #ecfdf5; border-radius: 0.375rem; border-left: 3px solid #10b981;">
                                    <div style="font-size: 0.75rem; font-weight: 600; color: #065f46; margin-bottom: 0.25rem;">🎯 Equivalent Amount:</div>
                                    <div style="font-size: 0.75rem; color: #047857;">
                                        <strong>${food.equivalentDisplay}</strong> provides the same nutrition as your current food
                                        ${food.nutritionalEquivalence ? ` (${food.nutritionalEquivalence}% match)` : ''}
                                    </div>
                                </div>
                                ` : ''}
                                ${food.servingSize !== 100 && !food.isIntelligentReplacement ? `
                                <div style="font-size: 0.75rem; color: #6b7280; font-style: italic;">
                                    Original (100g): ${food.originalFood.calories} cal, ${food.originalFood.protein}g protein, ${food.originalFood.carbs}g carbs, ${food.originalFood.fat}g fat
                                </div>
                                ` : ''}
                                ${(food.originalFood && food.originalFood.ingredients) || food.ingredients ? `
                                <div style="margin-top: 0.75rem; padding: 0.75rem; background: #f8fafc; border-radius: 0.375rem; border-left: 3px solid #3b82f6;">
                                    <div style="font-size: 0.75rem; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">🥄 Ingredients (per serving):</div>
                                    <div style="font-size: 0.7rem; color: #6b7280; line-height: 1.3;">
                                        ${(food.originalFood && food.originalFood.ingredients) || food.ingredients}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <div style="text-align: right; margin-left: 1rem;">
                                <div style="font-size: 0.875rem; font-weight: 600; color: ${similarityColor}; margin-bottom: 0.5rem;">
                                    ${food.similarityPercentage}% Match
                                </div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.75rem;">
                                    <div>±${Math.round(food.caloriesDiff)} cal</div>
                                    <div>±${food.proteinDiff.toFixed(1)}g protein</div>
                                </div>
                                <button style="background: #2563eb; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    Select This
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterFoods() {
            const searchTerm = document.getElementById('foodSearchInput').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const similarityLevel = parseInt(document.getElementById('similarityLevel').value);
            const priorityType = document.getElementById('priorityType').value;
            const adjustServing = document.getElementById('adjustServing').checked;
            const showOnlyCloser = document.getElementById('showOnlyCloser').checked;
            
            let filteredFoods = foodDatabase;
            
            // Apply text search filter
            if (searchTerm) {
                filteredFoods = filteredFoods.filter(food => 
                    food.name.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply category filter
            if (category) {
                filteredFoods = filteredFoods.filter(food => food.category === category);
            }
            
            // Calculate similarity for filtered foods with new parameters
            let similarFoods = findSimilarFoods(currentReplacementContext.originalNutrition, priorityType, adjustServing)
                .filter(food => filteredFoods.some(f => f.name === food.originalFood.name));
            
            // Apply similarity level filter
            if (similarityLevel > 0) {
                similarFoods = similarFoods.filter(food => food.similarityPercentage >= similarityLevel);
            }
            
            // Apply "show only closer" filter
            if (showOnlyCloser) {
                const originalTotal = currentReplacementContext.originalNutrition.calories + 
                                    currentReplacementContext.originalNutrition.protein + 
                                    currentReplacementContext.originalNutrition.carbs + 
                                    currentReplacementContext.originalNutrition.fat;
                                    
                similarFoods = similarFoods.filter(food => {
                    const foodTotal = food.calories + food.protein + food.carbs + food.fat;
                    const totalDiff = Math.abs(foodTotal - originalTotal);
                    return totalDiff < originalTotal * 0.2; // Within 20% of total nutritional value
                });
            }
            
            // Limit results to top 20 for performance
            similarFoods = similarFoods.slice(0, 20);
            
            document.getElementById('similarFoodsList').innerHTML = renderSimilarFoods(similarFoods);
            
            // Add event listeners to food selection items
            setupFoodSelectionListeners();
            
            // Update results count
            const resultsCount = similarFoods.length;
            // Find the h4 element that comes right before the similarFoodsList div
            const similarFoodsList = document.getElementById('similarFoodsList');
            if (similarFoodsList && similarFoodsList.previousElementSibling && similarFoodsList.previousElementSibling.tagName === 'H4') {
                similarFoodsList.previousElementSibling.textContent = `Similar Foods (${resultsCount} results):`;
            }
        }

        // Setup event listeners for food selection items
        function setupFoodSelectionListeners() {
            console.log('Setting up food selection listeners...');
            
            const foodItems = document.querySelectorAll('.food-selection-item');
            console.log('Found', foodItems.length, 'food selection items');
            
            foodItems.forEach((item, index) => {
                // Remove existing listeners to prevent duplicates
                item.removeEventListener('click', handleFoodSelectionClick);
                
                // Add new listener
                item.addEventListener('click', handleFoodSelectionClick);
                console.log(`Added listener to food item ${index + 1}: ${item.dataset.foodName}`);
            });
        }

        function handleFoodSelectionClick(event) {
            console.log('Food selection clicked!', event.target);
            
            const item = event.target.closest('.food-selection-item');
            if (!item) {
                console.error('Food selection item not found');
                return;
            }
            
            const foodName = item.dataset.foodName;
            const calories = parseFloat(item.dataset.calories);
            const protein = parseFloat(item.dataset.protein);
            const carbs = parseFloat(item.dataset.carbs);
            const fat = parseFloat(item.dataset.fat);
            const servingSize = parseFloat(item.dataset.servingSize);
            const defaultServingAmount = parseFloat(item.dataset.defaultServingAmount) || 100;
            const defaultServingUnit = item.dataset.defaultServingUnit || 'grams';
            
            console.log('Selecting food:', {
                foodName, calories, protein, carbs, fat, servingSize, defaultServingAmount, defaultServingUnit
            });
            
            selectReplacementFood(foodName, calories, protein, carbs, fat, servingSize, defaultServingAmount, defaultServingUnit);
        }

        async function selectReplacementFood(foodName, calories, protein, carbs, fat, servingSize = 100, defaultServingAmount = 100, defaultServingUnit = 'grams') {
            console.log('=== FOOD REPLACEMENT STARTED ===');
            console.log('Replacing with:', { foodName, calories, protein, carbs, fat, servingSize });
            console.log('Current context:', currentReplacementContext);
            
            // CRITICAL: Validate currentReplacementContext exists BEFORE proceeding
            if (!currentReplacementContext) {
                console.error('❌ CRITICAL ERROR: currentReplacementContext is null!');
                showMessage('Error: No food selected for replacement. Please click the replace button again.', 'error');
                return;
            }

            // Validate all required properties exist
            const requiredProperties = ['planId', 'mealType', 'itemIndex', 'currentFood'];
            const missingProperties = requiredProperties.filter(prop => 
                currentReplacementContext[prop] === undefined || 
                currentReplacementContext[prop] === null ||
                currentReplacementContext[prop] === ''
            );

            if (missingProperties.length > 0) {
                console.error('❌ Missing properties in currentReplacementContext:', missingProperties);
                console.error('Current context object:', currentReplacementContext);
                showMessage(`Error: Missing replacement data (${missingProperties.join(', ')}). Please click the replace button again.`, 'error');
                return;
            }

            if (!currentUser) {
                console.error('❌ User not authenticated');
                showMessage('User not authenticated. Please log in and try again.', 'error');
                return;
            }
            
            try {
                // Show loading state
                showMessage('Replacing food...', 'info');
                
                // Find the nutrition plan
                const plan = nutritionPlans.find(p => p.id === currentReplacementContext.planId);
                if (!plan) {
                    throw new Error('Nutrition plan not found');
                }
                
                console.log('Found nutrition plan:', plan.planName);

                // Validate current replacement context
                if (!currentReplacementContext) {
                    throw new Error('No replacement context found. Please try opening the replacement modal again.');
                }
                
                if (!currentReplacementContext.planId || !currentReplacementContext.mealType || 
                    currentReplacementContext.itemIndex === undefined) {
                    throw new Error('Invalid replacement context. Missing required data.');
                }

                // Determine if this is a multi-day meal plan
                const mealPlan = plan.mealPlan || {};
                const isMultiDay = Object.keys(mealPlan).some(key => !isNaN(key));
                
                console.log('Meal plan structure:', {
                    isMultiDay,
                    mealPlanKeys: Object.keys(mealPlan),
                    targetDay: currentReplacementContext.day,
                    targetMealType: currentReplacementContext.mealType,
                    targetItemIndex: currentReplacementContext.itemIndex
                });
                
                console.log('Replacing food:', {
                    isMultiDay,
                    day: currentReplacementContext.day,
                    mealType: currentReplacementContext.mealType,
                    itemIndex: currentReplacementContext.itemIndex,
                    newFood: foodName
                });

                // Create a deep copy of the meal plan
                const updatedMealPlan = JSON.parse(JSON.stringify(mealPlan));

                const newFoodItem = {
                    food: foodName,
                    name: foodName, // Support both food and name properties
                    calories: calories,
                    protein: protein,
                    carbs: carbs,
                    fat: fat,
                    servingAmount: defaultServingAmount,
                    servingUnit: defaultServingUnit
                };

                if (isMultiDay) {
                    // Multi-day format: { 1: {breakfast: [...], lunch: [...], dinner: [...]}, 2: {...}, ... }
                    const day = currentReplacementContext.day;
                    
                    if (!updatedMealPlan[day]) {
                        console.log(`Creating new day ${day} in meal plan`);
                        updatedMealPlan[day] = { breakfast: [], lunch: [], dinner: [] };
                    }
                    
                    if (!updatedMealPlan[day][currentReplacementContext.mealType]) {
                        console.log(`Creating new meal type ${currentReplacementContext.mealType} for day ${day}`);
                        updatedMealPlan[day][currentReplacementContext.mealType] = [];
                    }
                    
                    // Validate that the target index exists or is the next available index
                    const targetMeals = updatedMealPlan[day][currentReplacementContext.mealType];
                    if (currentReplacementContext.itemIndex >= targetMeals.length) {
                        // If index is beyond array length, extend the array
                        while (targetMeals.length <= currentReplacementContext.itemIndex) {
                            targetMeals.push(null);
                        }
                    }
                    
                    console.log(`Updating item at index ${currentReplacementContext.itemIndex} in day ${day}, ${currentReplacementContext.mealType}`);
                    updatedMealPlan[day][currentReplacementContext.mealType][currentReplacementContext.itemIndex] = newFoodItem;
                } else {
                    // Single-day format: { breakfast: [...], lunch: [...], dinner: [...] }
                    if (!updatedMealPlan[currentReplacementContext.mealType]) {
                        console.log(`Creating new meal type ${currentReplacementContext.mealType}`);
                        updatedMealPlan[currentReplacementContext.mealType] = [];
                    }
                    
                    // Validate that the target index exists or is the next available index
                    const targetMeals = updatedMealPlan[currentReplacementContext.mealType];
                    if (currentReplacementContext.itemIndex >= targetMeals.length) {
                        // If index is beyond array length, extend the array
                        while (targetMeals.length <= currentReplacementContext.itemIndex) {
                            targetMeals.push(null);
                        }
                    }
                    
                    console.log(`Updating item at index ${currentReplacementContext.itemIndex} in ${currentReplacementContext.mealType}`);
                    updatedMealPlan[currentReplacementContext.mealType][currentReplacementContext.itemIndex] = newFoodItem;
                }

                console.log('Updating Firebase with new meal plan...');
                
                // Update in Firebase
                const planRef = doc(db, "nutritionPlans", currentReplacementContext.planId);
                await updateDoc(planRef, {
                    mealPlan: updatedMealPlan,
                    updatedAt: new Date().toISOString(),
                    lastModifiedBy: 'client', // Track who made the change
                    lastModifiedAt: new Date().toISOString()
                });

                console.log('Firebase update successful');

                // Update local data
                plan.mealPlan = updatedMealPlan;

                // Close modal and refresh display
                closeFoodReplacementModal();
                
                console.log('Refreshing nutrition plans display...');
                await loadNutritionPlans(); // Refresh the display

                // Create intelligent success message
                const isIntelligent = item.dataset.isIntelligentReplacement === 'true';
                const nutritionalEquivalence = item.dataset.nutritionalEquivalence || '0';
                const servingMessage = servingSize !== 100 ? ` (${servingSize}g serving)` : '';
                
                // Use safe property access
                const oldFoodName = currentReplacementContext?.currentFood || 'Unknown Food';
                
                let successMessage;
                if (isIntelligent && nutritionalEquivalence > 80) {
                    const equivalentAmount = `${servingAmount}${servingUnit === 'grams' ? 'g' : servingUnit === 'pieces' ? ' pieces' : ` ${servingUnit}`}`;
                    successMessage = `🧠 Smart replacement complete! "${equivalentAmount} ${foodName}" provides equivalent nutrition to your original "${oldFoodName}" (${nutritionalEquivalence}% nutritional match)`;
                } else if (isIntelligent) {
                    const equivalentAmount = `${servingAmount}${servingUnit === 'grams' ? 'g' : servingUnit === 'pieces' ? ' pieces' : ` ${servingUnit}`}`;
                    successMessage = `✅ Replaced "${oldFoodName}" with "${equivalentAmount} ${foodName}" (${nutritionalEquivalence}% nutritional match)`;
                } else {
                    successMessage = `✅ Successfully replaced "${oldFoodName}" with "${foodName}${servingMessage}"!`;
                }
                
                console.log('Food replacement completed successfully');
                console.log('Intelligent replacement:', isIntelligent, 'Equivalence:', nutritionalEquivalence + '%');
                showMessage(successMessage, 'success');
            } catch (error) {
                console.error('=== FOOD REPLACEMENT ERROR ===');
                console.error('Error object:', error);
                console.error('Error message:', error.message);
                console.error('Error code:', error.code);
                console.error('Error stack:', error.stack);
                console.error('Current context:', currentReplacementContext);
                console.error('Nutrition plans:', nutritionPlans);
                console.error('Firebase auth:', auth.currentUser);
                
                let errorMessage = 'Failed to replace food. Please try again.';
                
                if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied. You may not have access to modify this nutrition plan.';
                } else if (error.code === 'not-found') {
                    errorMessage = 'Nutrition plan not found. Please refresh the page and try again.';
                } else if (error.message.includes('Nutrition plan not found')) {
                    errorMessage = 'Nutrition plan not found in local data. Please refresh the page.';
                } else if (error.message.includes('User not authenticated')) {
                    errorMessage = 'You are not logged in. Please log in and try again.';
                } else if (error.code) {
                    errorMessage = `Database error (${error.code}): ${error.message}`;
                } else if (error.message) {
                    errorMessage = `Error: ${error.message}`;
                }
                
                showMessage(errorMessage, 'error');
                
                // Also show a detailed error in console for debugging
                console.error('Detailed error information for debugging:');
                console.error('Plan ID:', currentReplacementContext?.planId);
                console.error('Available plan IDs:', nutritionPlans?.map(p => p.id));
                console.error('Current user UID:', auth.currentUser?.uid);
            }
        }

        function closeFoodReplacementModal() {
            console.log('=== CLOSING FOOD REPLACEMENT MODAL ===');
            console.log('Current context before closing:', currentReplacementContext);
            
            const modal = document.getElementById('foodReplacementModal');
            if (modal) {
                modal.remove();
                console.log('Modal removed from DOM');
            }
            
            // Only clear context after a short delay to allow for any pending food selections
            setTimeout(() => {
                console.log('Clearing replacement context after modal close');
                currentReplacementContext = null;
            }, 500);
        }

        // Setup event listeners for replace buttons
        function setupReplaceButtonListeners() {
            console.log('Setting up replace button listeners...');
            
            // Remove existing listeners to prevent duplicates
            document.querySelectorAll('.replace-food-btn').forEach(btn => {
                btn.removeEventListener('click', handleReplaceButtonClick);
            });
            
            // Add new listeners
            document.querySelectorAll('.replace-food-btn').forEach(btn => {
                btn.addEventListener('click', handleReplaceButtonClick);
                console.log('Added listener to replace button');
            });
        }

        function handleReplaceButtonClick(event) {
            console.log('Replace button clicked!', event.target);
            
            const btn = event.target.closest('.replace-food-btn');
            if (!btn) {
                console.error('Replace button not found');
                showMessage('Error: Replace button not found. Please refresh the page.', 'error');
                return;
            }
            
            // Extract data with validation
            const planId = btn.dataset.planId;
            const mealType = btn.dataset.mealType;
            const itemIndex = parseInt(btn.dataset.itemIndex);
            const currentFood = btn.dataset.currentFood;
            const calories = parseFloat(btn.dataset.calories) || 0;
            const protein = parseFloat(btn.dataset.protein) || 0;
            const carbs = parseFloat(btn.dataset.carbs) || 0;
            const fat = parseFloat(btn.dataset.fat) || 0;
            const day = parseInt(btn.dataset.day) || 1;
            
            // Validate required data
            if (!planId || !mealType || isNaN(itemIndex) || !currentFood) {
                console.error('Missing required data:', {
                    planId, mealType, itemIndex, currentFood
                });
                showMessage('Error: Missing food replacement data. Please refresh the page.', 'error');
                return;
            }
            
            console.log('Button data:', {
                planId, mealType, itemIndex, currentFood, calories, protein, carbs, fat, day
            });
            
            // Clear any existing context first
            currentReplacementContext = null;
            
            try {
                showFoodReplacementModal(planId, mealType, itemIndex, currentFood, calories, protein, carbs, fat, day);
                
                // Verify context was set
                if (!currentReplacementContext) {
                    throw new Error('Failed to set replacement context');
                }
                
                console.log('✅ Replacement context set successfully:', currentReplacementContext);
            } catch (error) {
                console.error('❌ Error in handleReplaceButtonClick:', error);
                showMessage('Failed to open food replacement modal. Please try again.', 'error');
            }
        }

        // Debug function to check replacement context
        function debugReplacementContext() {
            console.log('=== REPLACEMENT CONTEXT DEBUG ===');
            console.log('currentReplacementContext:', currentReplacementContext);
            console.log('currentReplacementContext type:', typeof currentReplacementContext);
            console.log('currentReplacementContext is null:', currentReplacementContext === null);
            console.log('currentReplacementContext is undefined:', currentReplacementContext === undefined);
            
            if (currentReplacementContext) {
                console.log('Context properties:');
                Object.keys(currentReplacementContext).forEach(key => {
                    console.log(`  ${key}:`, currentReplacementContext[key]);
                });
            }
            
            // Check if modal exists
            const modal = document.getElementById('foodReplacementModal');
            console.log('Modal exists:', !!modal);
            
            return currentReplacementContext;
        }
        
        window.debugReplacementContext = debugReplacementContext;

        // Test function for debugging replace buttons
        function testReplaceButtons() {
            console.log('=== REPLACE BUTTON TEST ===');
            const buttons = document.querySelectorAll('.replace-food-btn');
            console.log('Found', buttons.length, 'replace buttons');
            
            buttons.forEach((btn, index) => {
                console.log(`Button ${index + 1}:`, {
                    planId: btn.dataset.planId,
                    mealType: btn.dataset.mealType,
                    itemIndex: btn.dataset.itemIndex,
                    currentFood: btn.dataset.currentFood,
                    hasEventListener: btn.onclick !== null || btn.hasEventListeners
                });
            });
            
            if (buttons.length > 0) {
                console.log('Testing first button click...');
                buttons[0].click();
            } else {
                console.log('No replace buttons found. Make sure nutrition plans are loaded.');
            }
        }
        
        // Make test function globally accessible
        window.testReplaceButtons = testReplaceButtons;
        
        // Test function for food selection
        function testFoodSelection() {
            console.log('=== FOOD SELECTION TEST ===');
            const foodItems = document.querySelectorAll('.food-selection-item');
            console.log('Found', foodItems.length, 'food selection items');
            
            foodItems.forEach((item, index) => {
                console.log(`Food item ${index + 1}:`, {
                    foodName: item.dataset.foodName,
                    calories: item.dataset.calories,
                    protein: item.dataset.protein,
                    carbs: item.dataset.carbs,
                    fat: item.dataset.fat,
                    servingSize: item.dataset.servingSize
                });
            });
            
            if (foodItems.length > 0) {
                console.log('Testing first food selection...');
                foodItems[0].click();
            } else {
                console.log('No food selection items found. Open the food replacement modal first.');
            }
        }
        
        // Test food replacement process
        function testFoodReplacement() {
            console.log('=== FOOD REPLACEMENT DEBUGGING ===');
            console.log('Current user:', currentUser);
            console.log('Nutrition plans loaded:', nutritionPlans?.length);
            console.log('Current replacement context:', currentReplacementContext);
            console.log('Firebase auth:', auth.currentUser);
            console.log('Database connection:', db);
            
            if (nutritionPlans && nutritionPlans.length > 0) {
                console.log('Available nutrition plans:');
                nutritionPlans.forEach((plan, index) => {
                    console.log(`Plan ${index + 1}:`, {
                        id: plan.id,
                        planName: plan.planName,
                        clientName: plan.clientName,
                        hasMealPlan: !!plan.mealPlan,
                        mealPlanKeys: plan.mealPlan ? Object.keys(plan.mealPlan) : []
                    });
                });
            }
            
            // Test Firebase connection
            if (auth.currentUser) {
                console.log('User is authenticated:', auth.currentUser.uid);
                testFirebaseConnection();
            } else {
                console.log('User is not authenticated');
            }
        }
        
        window.testFoodSelection = testFoodSelection;
        window.testFoodReplacement = testFoodReplacement;

        // Comprehensive test for the entire food replacement flow
        function testCompleteReplacementFlow() {
            console.log('=== COMPLETE REPLACEMENT FLOW TEST ===');
            
            // Step 1: Check if nutrition plans are loaded
            console.log('Step 1: Checking nutrition plans...');
            console.log('Nutrition plans loaded:', nutritionPlans?.length || 0);
            
            if (!nutritionPlans || nutritionPlans.length === 0) {
                console.log('❌ No nutrition plans loaded. Load nutrition plans first.');
                return false;
            }
            
            // Step 2: Check if replace buttons exist
            console.log('Step 2: Checking replace buttons...');
            const replaceButtons = document.querySelectorAll('.replace-food-btn');
            console.log('Replace buttons found:', replaceButtons.length);
            
            if (replaceButtons.length === 0) {
                console.log('❌ No replace buttons found. Make sure nutrition plan is displayed.');
                return false;
            }
            
            // Step 3: Test clicking a replace button
            console.log('Step 3: Testing replace button click...');
            const firstButton = replaceButtons[0];
            console.log('Button data:', {
                planId: firstButton.dataset.planId,
                mealType: firstButton.dataset.mealType,
                itemIndex: firstButton.dataset.itemIndex,
                currentFood: firstButton.dataset.currentFood
            });
            
            // Simulate button click
            firstButton.click();
            
            // Step 4: Check if context was set
            console.log('Step 4: Checking replacement context...');
            debugReplacementContext();
            
            // Step 5: Check if modal was created
            console.log('Step 5: Checking modal...');
            const modal = document.getElementById('foodReplacementModal');
            console.log('Modal exists:', !!modal);
            
            if (modal) {
                // Step 6: Check food selection items
                console.log('Step 6: Checking food selection items...');
                const foodItems = modal.querySelectorAll('.food-selection-item');
                console.log('Food selection items found:', foodItems.length);
                
                if (foodItems.length > 0) {
                    console.log('✅ Complete flow test passed! You can now click on a food item to test selection.');
                    return true;
                } else {
                    console.log('❌ No food selection items found in modal.');
                    return false;
                }
            } else {
                console.log('❌ Modal was not created.');
                return false;
            }
        }
        
        window.testCompleteReplacementFlow = testCompleteReplacementFlow;

        // Debug function to check all DOM elements
        function checkAllElements() {
            console.log('=== DOM ELEMENTS CHECK ===');
            
            const elementIds = [
                'authScreen', 'dashboard', 'userName', 'userEmail', 'currentWeight',
                'goalProgress', 'progressChange', 'weightProgressBar', 'weightProgressText',
                'workoutProgressBar', 'workoutProgressText', 'nutritionLoadingMessage',
                'nutritionPlansContainer', 'profileName', 'profileEmail', 'profilePhone',
                'profileAge', 'profileWeight', 'profileHeight', 'profileGoals'
            ];
            
            const missing = [];
            const existing = [];
            
            elementIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    existing.push(id);
                } else {
                    missing.push(id);
                }
            });
            
            console.log('✅ Elements found:', existing.length);
            existing.forEach(id => console.log(`  ✓ ${id}`));
            
            console.log('❌ Elements missing:', missing.length);
            missing.forEach(id => console.log(`  ✗ ${id}`));
            
            return { existing, missing };
        }
        
        // Auto-check elements on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, checking elements...');
            checkAllElements();
        });
        
        window.checkAllElements = checkAllElements;

        // Global error handler for uncaught errors
        window.addEventListener('error', function(event) {
            console.error('=== GLOBAL ERROR CAUGHT ===');
            console.error('Error message:', event.message);
            console.error('Error filename:', event.filename);
            console.error('Error line:', event.lineno);
            console.error('Error column:', event.colno);
            console.error('Error object:', event.error);
            
            // Check if it's a null property error
            if (event.message && event.message.includes("Cannot read properties of null")) {
                console.error('🚨 NULL PROPERTY ERROR DETECTED!');
                console.error('This usually means a DOM element was not found.');
                console.error('Running element check...');
                checkAllElements();
                
                showMessage('DOM error detected. Check console for details.', 'error');
            }
        });

        // Global promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('=== UNHANDLED PROMISE REJECTION ===');
            console.error('Reason:', event.reason);
            console.error('Promise:', event.promise);
        });

    </script>
</body>
</html>
